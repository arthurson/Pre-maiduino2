<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ—ãƒªãƒ¡ã‚¤ãƒ‰AI æ§åˆ¶å™¨ (èˆŠç‰ˆé¢¨æ ¼)</title>
    <style>
        /* èˆŠç‰ˆé¢¨æ ¼ï¼šé•·æ–¹å½¢æŒ‰éˆ•ï¼Œç„¡ä¸Šæ–¹hotkeyæç¤ºåˆ— */
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
        }
        body {
            background: #1a1a2e;
            color: #fff;
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 10px;
        }
        h1 {
            color: #00d4ff;
            text-align: center;
            margin: 0 0 5px 0;
            font-size: 1.8em;
        }
        h1 small {
            font-size: 14px;
            color: #888;
            display: block;
        }

        /* é ‚éƒ¨æ§åˆ¶åˆ— - è„«åŠ›æŒ‰éˆ•æ”¾åœ¨åŒä¸€è¡Œ */
        .top-control-bar {
            background: #16213e;
            border-radius: 4px;          /* èˆŠç‰ˆæ–¹å½¢æ„Ÿ */
            padding: 10px 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            border: 1px solid #0f3460;
        }
        .btn {
            background: #00d4ff;
            color: #1a1a2e;
            border: none;
            padding: 6px 14px;
            border-radius: 4px;           /* é•·æ–¹å½¢ (èˆŠç‰ˆ) */
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            transition: 0.2s;
            white-space: nowrap;
        }
        .btn:hover {
            background: #00b8e6;
            transform: scale(1.02);
        }
        .btn-danger {
            background: #ff4444;
            color: white;
        }
        .btn-success {
            background: #00cc66;
            color: white;
        }
        .btn-warning {
            background: #ffaa00;
            color: black;
        }
        .btn-home {
            background: #ffaa00;
            color: black;
        }
        .btn-free {                         /* è„«åŠ›æŒ‰éˆ•çµ±ä¸€ç´«è‰² */
            background: #9b59b6;
            color: white;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .status {
            background: #0f3460;
            padding: 5px 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
            margin-left: auto;
        }
        .selected-servo-hint {
            background: #ffaa00;
            color: #1a1a2e;
            padding: 5px 15px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 13px;
        }
        .separator {
            width: 1px;
            height: 28px;
            background: #0f3460;
            margin: 0 5px;
        }

        /* ä¸»å€åŸŸ */
        .main-layout {
            display: flex;
            gap: 12px;
            flex: 1;
            min-height: 0;
        }

        /* å·¦å´éƒ¨ä½å°èˆª (èˆŠç‰ˆæ–¹å½¢æŒ‰éˆ•) */
        .robot-diagram {
            width: 180px;
            background: #16213e;
            border-radius: 4px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .part-button {
            width: 100%;
            padding: 12px;
            border-radius: 4px;            /* æ–¹å½¢ */
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            text-align: center;
            transition: 0.2s;
            color: white;
        }
        .part-button.head {
            background: #9b59b6;
        }
        .part-button.hand {
            background: #3498db;
        }
        .part-button.leg {
            background: #e67e22;
        }
        .part-button.active {
            border: 2px solid #00d4ff;
            box-shadow: 0 0 10px #00d4ff;
        }

        /* å³å´æ§åˆ¶é¢æ¿ */
        .control-panel {
            flex: 1;
            background: #16213e;
            border-radius: 4px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #0f3460;
        }
        .panel-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #00d4ff;
        }
        .panel-meta {
            background: #0f3460;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75em;
            color: #aaa;
        }

        /* ä¼ºæœå®¹å™¨ */
        .servo-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        /* å·¦å³åˆ†æ¬„ (æ‰‹/è…³ç”¨) */
        .split-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            height: 100%;
        }
        .split-left, .split-right {
            display: flex;
            flex-direction: column;
            gap: 6px;
            overflow-y: auto;
            padding-right: 5px;
        }
        .split-title {
            color: #888;
            font-size: 0.85em;
            text-align: center;
            padding: 4px;
            background: #0f3460;
            border-radius: 4px;
        }

        /* ä¼ºæœåˆ— (èˆŠç‰ˆç„¡åœ“è§’) */
        .servo-row {
            background: #0f3460;
            border-radius: 4px;             /* æ–¹å½¢ */
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-left: 4px solid;
            transition: 0.2s;
        }
        .servo-row.MV {
            border-left-color: #00d4ff;
        }
        .servo-row.HV {
            border-left-color: #ffaa00;
        }
        .servo-row.active-inc {
            background: #00cc66 !important;
        }
        .servo-row.active-dec {
            background: #ff4444 !important;
        }
        .servo-row.selected {
            outline: 2px solid #00d4ff;
        }

        .servo-info {
            flex: 2;
            min-width: 100px;
        }
        .servo-name {
            font-weight: bold;
            font-size: 0.9em;
        }
        .servo-detail {
            font-size: 0.7em;
            color: #aaa;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        .pma-id {
            background: #00d4ff22;
            color: #00d4ff;
            padding: 2px 6px;
            border-radius: 4px;              /* æ–¹å½¢å°æ¨™ç±¤ */
        }
        .home-star {
            color: #ffaa00;
            font-weight: bold;
        }
        .shortkey-badge {
            background: #00d4ff;
            color: #1a1a2e;
            padding: 2px 8px;
            border-radius: 4px;               /* æ–¹å½¢å¿«æ·éµ */
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
        }
        .shortkey-badge:hover {
            background: #ffaa00;
        }

        /* æ§åˆ¶é … */
        .controls-wrapper {
            flex: 3;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .angle-control, .speed-control {
            display: flex;
            align-items: center;
            gap: 3px;
            background: #1a1a2e;
            padding: 2px 5px;
            border-radius: 4px;                /* æ–¹å½¢ */
        }
        .angle-control {
            border-left: 2px solid #00d4ff;
        }
        .speed-control {
            border-left: 2px solid #ffaa00;
        }
        .angle-label, .speed-label {
            font-size: 0.65em;
            font-weight: bold;
        }
        .angle-label { color: #00d4ff; }
        .speed-label { color: #ffaa00; }
        .btn-angle, .btn-speed {
            background: #0f3460;
            border: none;
            width: 22px;
            height: 22px;
            border-radius: 4px;                /* æ–¹å½¢æŒ‰éˆ• */
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-angle {
            color: #00d4ff;
        }
        .btn-speed {
            color: #ffaa00;
        }
        .btn-angle:hover {
            background: #00d4ff;
            color: #1a1a2e;
        }
        .btn-speed:hover {
            background: #ffaa00;
            color: #1a1a2e;
        }
        .angle-input, .speed-input {
            background: #1a1a2e;
            border: 1px solid;
            border-radius: 4px;                /* æ–¹å½¢è¼¸å…¥æ¡† */
            padding: 3px 3px;
            font-family: monospace;
            font-size: 0.85em;
            text-align: center;
            outline: none;
            width: 60px;
        }
        .angle-input {
            color: #00d4ff;
            border-color: #00d4ff;
        }
        .speed-input {
            color: #ffaa00;
            border-color: #ffaa00;
            width: 45px;
        }

        /* åº•éƒ¨é›™æ¬„ (GYRO + LOG) */
        .bottom-dual {
            display: flex;
            gap: 12px;
            height: 150px;
            flex-shrink: 0;
        }
        .gyro-section, .log-section {
            flex: 1;
            background: #16213e;
            border-radius: 4px;                /* æ–¹å½¢ */
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .gyro-header, .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .gyro-title {
            color: #9b59b6;
            font-weight: bold;
            font-size: 0.95em;
        }
        .log-title {
            color: #00d4ff;
            font-weight: bold;
            font-size: 0.95em;
        }
        .gyro-content, .log-content {
            flex: 1;
            background: #0f3460;
            border-radius: 4px;
            padding: 8px;
            font-family: monospace;
            font-size: 11px;
            overflow-y: auto;
            line-height: 1.4;
        }
        .gyro-content {
            color: #9b59b6;
        }
        .log-content {
            color: #00d4ff;
        }
        .log-sent { color: #00d4ff; }
        .log-received { color: #00cc66; }

        /* æ»¾å‹•æ¢ (ç´°å°) */
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: #0f3460;
        }
        ::-webkit-scrollbar-thumb {
            background: #00d4ff;
            border-radius: 0px;                /* æ–¹å½¢æ»¾å‹•æ¢ */
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ¤– ãƒ—ãƒªãƒ¡ã‚¤ãƒ‰AI èˆŠç‰ˆé¢¨æ ¼æ§åˆ¶å™¨ <small>HOMEé€Ÿåº¦30 / è„«åŠ›:é ­é›™æ‰‹é›™è…³</small></h1>

    <!-- é ‚éƒ¨å·¥å…·åˆ—ï¼šé€£æ¥ï¼‹è„«åŠ›å…¨éƒ¨åœ¨åŒä¸€è¡Œ (ç„¡hotkeyæç¤º) -->
    <div class="top-control-bar">
        <button class="btn" id="connectBtn">ğŸ”Œ é€£æ¥</button>
        <button class="btn btn-danger" id="disconnectBtn" disabled>âŒ æ–·é–‹</button>
        <button class="btn btn-warning" id="scanBtn">ğŸ” æƒæ</button>
        <button class="btn btn-success" id="testBtn">ğŸ“¡ æ¸¬è©¦</button>
        <span class="separator"></span>

        <!-- HOME æŒ‰éˆ•ç¾¤ (é€Ÿåº¦30) -->
        <button class="btn btn-home" id="homeAllBtn">ğŸ  å…¨éƒ¨HOME</button>
        <button class="btn btn-home" id="homeHeadBtn">ğŸ‘¤ é ­HOME</button>
        <button class="btn btn-home" id="homeHandBtn">ğŸ–ï¸ æ‰‹HOME</button>
        <button class="btn btn-home" id="homeLegBtn">ğŸ¦¶ è…³HOME</button>
        <span class="separator"></span>

        <!-- è„«åŠ›æŒ‰éˆ•ï¼šé ­ã€é›™æ‰‹ã€é›™è…³ (ç„¡å…¨èº«) å¿«æ·éµ 8 9 10 æ¨™è¨»åœ¨æ–‡å­—ä¸Š -->
        <button class="btn btn-free" id="freeHeadBtn">ğŸ’¤ é ­è„«åŠ› [8]</button>
        <button class="btn btn-free" id="freeHandBtn">ğŸ’¤ é›™æ‰‹è„«åŠ› [9]</button>
        <button class="btn btn-free" id="freeLegBtn">ğŸ’¤ é›™è…³è„«åŠ› [10]</button>

        <div class="status" id="status">âš¡ æœªé€£æ¥</div>
        <div class="selected-servo-hint" id="selectedHint">âš¡ æœªé¸ä¸­ä¼ºæœ</div>
    </div>

    <!-- ä¸»é«” -->
    <div class="main-layout">
        <!-- å·¦å´éƒ¨ä½å°èˆª (ç„¡hotkeyæç¤º) -->
        <div class="robot-diagram">
            <button class="part-button head active" id="navHead">ğŸ‘¤ é ­éƒ¨</button>
            <button class="part-button hand" id="navHand">ğŸ–ï¸ æ‰‹éƒ¨</button>
            <button class="part-button leg" id="navLeg">ğŸ¦¶ è…³éƒ¨</button>
        </div>

        <!-- å³å´æ§åˆ¶é¢æ¿ (å‹•æ…‹ç”¢ç”Ÿ) -->
        <div class="control-panel" id="controlPanel">
            <div class="panel-header">
                <span class="panel-title" id="panelTitle">ğŸ‘¤ é ­éƒ¨æ§åˆ¶</span>
                <span class="panel-meta" id="panelMeta"></span>
            </div>
            <div class="servo-container" id="servoContainer"></div>
        </div>
    </div>

    <!-- åº•éƒ¨ GYRO + LOG -->
    <div class="bottom-dual">
        <div class="gyro-section">
            <div class="gyro-header">
                <div class="gyro-title">ğŸ“Š é™€èºå„€</div>
                <button class="btn" id="clearGyroBtn" style="padding:2px 8px;">æ¸…é™¤</button>
            </div>
            <div class="gyro-content" id="gyroContent">ç­‰å¾…é™€èºå„€æ•¸æ“šâ€¦</div>
        </div>
        <div class="log-section">
            <div class="log-header">
                <div class="log-title">ğŸ“‹ é€šè¨Šè¨˜éŒ„</div>
                <button class="btn" id="clearLogBtn" style="padding:2px 8px;">æ¸…é™¤</button>
            </div>
            <div class="log-content" id="logContent">[ç³»çµ±] èˆŠç‰ˆæ§åˆ¶å™¨å•Ÿå‹• (HOMEé€Ÿåº¦30)</div>
        </div>
    </div>
</div>

<script>
    (function() {
        // ========== æ ¹æ“š new homepoint.txt å»ºç«‹çš„ä¼ºæœè³‡æ–™åº« ==========
        const SERVOS = [
            // é ­ (MV)
            { id:1, pma:'02', nameZh:'é ­éƒ¨ä¿¯ä»°', min:7200, max:8400, home:7500, group:'MV', part:'head', shortKey:{ dec:'q', inc:'w' }, speed:30 },
            { id:2, pma:'03', nameZh:'é ­éƒ¨å·¦å³', min:5000, max:10000, home:7500, group:'MV', part:'head', shortKey:{ dec:'e', inc:'r' }, speed:30 },
            { id:3, pma:'07', nameZh:'é ­éƒ¨èŒ',   min:6900, max:8100, home:7500, group:'MV', part:'head', shortKey:{ dec:'t', inc:'y' }, speed:30 },
            // å³æ‰‹
            { id:1, pma:'02', nameZh:'å³è‚© pitch', min:4300, max:11500, home:10200, group:'HV', part:'rhand', shortKey:{ dec:'q', inc:'w' }, speed:30 },
            { id:4, pma:'09', nameZh:'å³è‚© roll',  min:7450, max:10350, home:9800, group:'MV', part:'rhand', shortKey:{ dec:'e', inc:'r' }, speed:30 },
            { id:6, pma:'0D', nameZh:'å³ä¸Šè‡‚ yaw', min:4000, max:11000, home:7500, group:'MV', part:'rhand', shortKey:{ dec:'t', inc:'y' }, speed:30 },
            { id:8, pma:'11', nameZh:'å³è‚˜ pitch', min:7100, max:11000, home:7500, group:'MV', part:'rhand', shortKey:{ dec:'u', inc:'i' }, speed:30 },
            { id:10, pma:'15', nameZh:'å³æ‰‹è…• yaw', min:3500, max:11500, home:5000, group:'MV', part:'rhand', shortKey:{ dec:'o', inc:'p' }, speed:30 },
            // å·¦æ‰‹
            { id:2, pma:'04', nameZh:'å·¦è‚© pitch', min:3500, max:10700, home:4700, group:'HV', part:'lhand', shortKey:{ dec:'a', inc:'s' }, speed:30 },
            { id:5, pma:'0B', nameZh:'å·¦è‚© roll',  min:4550, max:7550, home:5200, group:'MV', part:'lhand', shortKey:{ dec:'d', inc:'f' }, speed:30 },
            { id:7, pma:'0F', nameZh:'å·¦ä¸Šè‡‚ yaw', min:4000, max:11000, home:7500, group:'MV', part:'lhand', shortKey:{ dec:'g', inc:'h' }, speed:30 },
            { id:9, pma:'13', nameZh:'å·¦è‚˜ pitch', min:4000, max:7900, home:7500, group:'MV', part:'lhand', shortKey:{ dec:'j', inc:'k' }, speed:30 },
            { id:11, pma:'17', nameZh:'å·¦æ‰‹è…• yaw', min:3500, max:11500, home:10000, group:'MV', part:'lhand', shortKey:{ dec:'l', inc:';' }, speed:30 },
            // å³è…³ HV (ç²¾ç¢ºhomeå€¼)
            { id:3, pma:'06', nameZh:'å³é«– yaw',   min:6530, max:9030, home:7780, group:'HV', part:'rleg', shortKey:{ dec:'q', inc:'w' }, speed:30 },
            { id:5, pma:'0A', nameZh:'å³é«– roll',  min:6700, max:8300, home:7400, group:'HV', part:'rleg', shortKey:{ dec:'e', inc:'r' }, speed:30 },
            { id:7, pma:'0E', nameZh:'å³å¤§è…¿ pitch', min:4700, max:10200, home:7500, group:'HV', part:'rleg', shortKey:{ dec:'t', inc:'y' }, speed:30 },
            { id:9, pma:'12', nameZh:'å³è† pitch', min:3950, max:7600, home:7500, group:'HV', part:'rleg', shortKey:{ dec:'u', inc:'i' }, speed:30 },
            { id:11, pma:'16', nameZh:'å³è¸ pitch', min:5700, max:8300, home:7500, group:'HV', part:'rleg', shortKey:{ dec:'o', inc:'p' }, speed:30 },
            { id:13, pma:'1A', nameZh:'å³è¸ roll',  min:6800, max:9150, home:7825, group:'HV', part:'rleg', shortKey:{ dec:'[', inc:']' }, speed:30 },
            // å·¦è…³ HV
            { id:4, pma:'08', nameZh:'å·¦é«– yaw',   min:6250, max:8750, home:7500, group:'HV', part:'lleg', shortKey:{ dec:'a', inc:'s' }, speed:30 },
            { id:6, pma:'0C', nameZh:'å·¦é«– roll',  min:6700, max:8300, home:7600, group:'HV', part:'lleg', shortKey:{ dec:'d', inc:'f' }, speed:30 },
            { id:8, pma:'10', nameZh:'å·¦å¤§è…¿ pitch', min:4700, max:10200, home:7500, group:'HV', part:'lleg', shortKey:{ dec:'g', inc:'h' }, speed:30 },
            { id:10, pma:'14', nameZh:'å·¦è† pitch', min:7400, max:11050, home:7500, group:'HV', part:'lleg', shortKey:{ dec:'j', inc:'k' }, speed:30 },
            { id:12, pma:'18', nameZh:'å·¦è¸ pitch', min:6750, max:9350, home:7550, group:'HV', part:'lleg', shortKey:{ dec:'l', inc:';' }, speed:30 },
            { id:14, pma:'1C', nameZh:'å·¦è¸ roll',  min:6200, max:8450, home:7450, group:'HV', part:'lleg', shortKey:{ dec:'\'', inc:'\\' }, speed:30 }
        ];

        // ========== å…¨åŸŸè®Šæ•¸ ==========
        let currentPart = 'head';
        let port = null, reader = null;
        let currentAngles = {};          // å­˜æ”¾æœ€æ–°è§’åº¦
        let selectedServo = null;
        let pressedKeys = new Set();
        let repeatTimer = null, activeServo = null, activeDelta = 0, isKeyHeld = false;

        // ========== è¼”åŠ©å‡½å¼ ==========
        function addLog(msg, type='info') {
            const log = document.getElementById('logContent');
            const time = new Date().toLocaleTimeString();
            const cls = type==='sent'?'log-sent':type==='received'?'log-received':'';
            log.innerHTML += `<div><span class="${cls}">[${time}] ${msg}</span></div>`;
            log.scrollTop = log.scrollHeight;
            if(log.children.length>40) log.removeChild(log.firstChild);
        }
        function addGyro(msg) {
            const g = document.getElementById('gyroContent');
            const time = new Date().toLocaleTimeString();
            g.innerHTML += `<div>[${time}] ${msg}</div>`;
            g.scrollTop = g.scrollHeight;
            if(g.children.length>10) g.removeChild(g.firstChild);
        }
        function delay(ms) { return new Promise(r=>setTimeout(r,ms)); }

        // ========== æ¸²æŸ“é¢æ¿ (èˆŠç‰ˆç„¡hotkeyæç¤º) ==========
        function renderPanel(part) {
            currentPart = part;
            document.querySelectorAll('.part-button').forEach(b=>b.classList.remove('active'));
            document.getElementById(`nav${part.charAt(0).toUpperCase()+part.slice(1)}`).classList.add('active');

            let title = part==='head'? 'ğŸ‘¤ é ­éƒ¨æ§åˆ¶' : part==='hand'? 'ğŸ–ï¸ æ‰‹éƒ¨æ§åˆ¶' : 'ğŸ¦¶ è…³éƒ¨æ§åˆ¶';
            document.getElementById('panelTitle').innerText = title;
            document.getElementById('panelMeta').innerText = ''; // ä¸é¡¯ç¤ºå¤šé¤˜æç¤º

            let html = '';
            if (part === 'head') {
                html = '<div class="split-left" style="grid-column:span2;">';
                SERVOS.filter(s=>s.part==='head').forEach(s=> html += renderServoRow(s));
                html += '</div>';
            } else if (part === 'hand') {
                html = '<div class="split-panel"><div class="split-left"><div class="split-title">ğŸ‘‰ å³æ‰‹</div>';
                SERVOS.filter(s=>s.part==='rhand').forEach(s=> html += renderServoRow(s));
                html += '</div><div class="split-right"><div class="split-title">ğŸ‘ˆ å·¦æ‰‹</div>';
                SERVOS.filter(s=>s.part==='lhand').forEach(s=> html += renderServoRow(s));
                html += '</div></div>';
            } else {
                html = '<div class="split-panel"><div class="split-left"><div class="split-title">ğŸ¦¶ å³è…³</div>';
                SERVOS.filter(s=>s.part==='rleg').forEach(s=> html += renderServoRow(s));
                html += '</div><div class="split-right"><div class="split-title">ğŸ¦¶ å·¦è…³</div>';
                SERVOS.filter(s=>s.part==='lleg').forEach(s=> html += renderServoRow(s));
                html += '</div></div>';
            }
            document.getElementById('servoContainer').innerHTML = html;
            attachInputEvents();
            if(selectedServo) highlightSelected();
        }

        function renderServoRow(s) {
            const angle = currentAngles[`${s.group}_${s.id}`] || s.home;
            const decKey = s.shortKey.dec === '\'' ? '\'' : s.shortKey.dec;
            const incKey = s.shortKey.inc === '\\' ? '\\' : s.shortKey.inc;
            return `
                <div class="servo-row ${s.group}" id="row_${s.group}_${s.id}" data-group="${s.group}" data-id="${s.id}">
                    <div class="servo-info">
                        <div class="servo-name">${s.nameZh}</div>
                        <div class="servo-detail">
                            <span class="pma-id">PMA ${s.pma}</span>
                            <span>${s.group}${s.id}</span>
                            ${s.home!==7500?'<span class="home-star">â˜…</span>':''}
                            <span class="shortkey-badge" onclick="window.selectByKey('${s.shortKey.dec}')">${decKey}</span>
                            <span class="shortkey-badge" onclick="window.selectByKey('${s.shortKey.inc}')">${incKey}</span>
                        </div>
                    </div>
                    <div class="controls-wrapper">
                        <div class="angle-control">
                            <span class="angle-label">è§’</span>
                            <button class="btn-angle" onclick="window.sendDelta('${s.group}',${s.id},-50)">âˆ’</button>
                            <input type="text" class="angle-input" id="input_${s.group}_${s.id}" value="${angle}" data-group="${s.group}" data-id="${s.id}">
                            <button class="btn-angle" onclick="window.sendDelta('${s.group}',${s.id},50)">+</button>
                        </div>
                        <div class="speed-control">
                            <span class="speed-label">é€Ÿ</span>
                            <button class="btn-speed" onclick="window.adjustSp('${s.group}',${s.id},-5)">âˆ’</button>
                            <input type="text" class="speed-input" id="speed_${s.group}_${s.id}" value="${s.speed}" data-group="${s.group}" data-id="${s.id}">
                            <button class="btn-speed" onclick="window.adjustSp('${s.group}',${s.id},5)">+</button>
                        </div>
                    </div>
                </div>`;
        }

        function attachInputEvents() {
            document.querySelectorAll('.angle-input').forEach(inp => {
                inp.addEventListener('blur', e => {
                    const g = inp.dataset.group, id = parseInt(inp.dataset.id);
                    let val = parseInt(inp.value);
                    if(isNaN(val)) { const s=SERVOS.find(s=>s.group===g&&s.id===id); if(s) inp.value=s.home; return; }
                    sendExactAngle(g,id,val);
                });
            });
            document.querySelectorAll('.speed-input').forEach(inp => {
                inp.addEventListener('blur', e => {
                    const g = inp.dataset.group, id = parseInt(inp.dataset.id);
                    let sp = parseInt(inp.value);
                    if(isNaN(sp)) sp=30; if(sp<0) sp=0; if(sp>127) sp=127;
                    inp.value = sp;
                    const s = SERVOS.find(s=>s.group===g&&s.id===id);
                    if(s) s.speed = sp;
                    if(selectedServo && selectedServo.group===g && selectedServo.id===id)
                        document.getElementById('selectedHint').innerText = `âš¡ é¸ä¸­: ${s.nameZh} é€Ÿåº¦${sp}`;
                });
            });
        }

        function highlightSelected() {
            document.querySelectorAll('.servo-row').forEach(r=>r.classList.remove('selected'));
            if(selectedServo) {
                const row = document.getElementById(`row_${selectedServo.group}_${selectedServo.id}`);
                if(row) row.classList.add('selected');
                document.getElementById('selectedHint').innerText = `âš¡ é¸ä¸­: ${selectedServo.nameZh} é€Ÿåº¦${selectedServo.speed}`;
            }
        }

        window.selectByKey = function(key) {
            const list = SERVOS.filter(s => 
                s.part === currentPart || 
                (currentPart==='hand' && (s.part==='rhand'||s.part==='lhand')) ||
                (currentPart==='leg' && (s.part==='rleg'||s.part==='lleg'))
            );
            const s = list.find(s=>s.shortKey.dec===key || s.shortKey.inc===key);
            if(s) { selectedServo = s; highlightSelected(); addLog(`âœ… é¸ä¸­ ${s.nameZh}`,'info'); }
        };

        // ========== æŒ‡ä»¤ç™¼é€ ==========
        async function sendRaw(cmd) {
            if(!port) { addLog('âŒ æœªé€£æ¥','error'); return false; }
            try {
                const w = port.writable.getWriter();
                await w.write(new TextEncoder().encode(cmd + '\n'));
                w.releaseLock();
                addLog('ğŸ“¤ ' + cmd, 'sent');
                return true;
            } catch(e) { addLog(`âŒ ç™¼é€å¤±æ•— ${e.message}`,'error'); return false; }
        }

        window.sendDelta = async function(group, id, delta) {
            if(!port) { alert('è«‹å…ˆé€£æ¥'); return; }
            const s = SERVOS.find(s=>s.group===group && s.id===id);
            if(!s) return;
            const inp = document.getElementById(`input_${group}_${id}`);
            let cur = parseInt(inp.value);
            let nv = cur + delta;
            if(nv < s.min) nv = s.min; if(nv > s.max) nv = s.max;
            inp.value = nv;
            currentAngles[`${group}_${id}`] = nv;
            await sendRaw(`S ${group} ${id} ${nv} ${s.speed}`);
            const row = document.getElementById(`row_${group}_${id}`);
            if(row) {
                row.classList.add(delta<0?'active-dec':'active-inc');
                setTimeout(()=>row.classList.remove('active-dec','active-inc'),300);
            }
        };

        async function sendExactAngle(group,id,val) {
            const s = SERVOS.find(s=>s.group===group && s.id===id);
            if(!s) return;
            if(val < s.min) val = s.min; if(val > s.max) val = s.max;
            document.getElementById(`input_${group}_${id}`).value = val;
            currentAngles[`${group}_${id}`] = val;
            await sendRaw(`S ${group} ${id} ${val} ${s.speed}`);
        }

        window.adjustSp = function(group,id,delta) {
            const s = SERVOS.find(s=>s.group===group && s.id===id);
            if(!s) return;
            let ns = s.speed + delta;
            if(ns<0) ns=0; if(ns>127) ns=127;
            s.speed = ns;
            const inp = document.getElementById(`speed_${group}_${id}`);
            if(inp) inp.value = ns;
            if(selectedServo && selectedServo.group===group && selectedServo.id===id)
                document.getElementById('selectedHint').innerText = `âš¡ é¸ä¸­: ${s.nameZh} é€Ÿåº¦${ns}`;
        };

        // ========== HOME åŠŸèƒ½ (S MULTI é€Ÿåº¦30) ==========
        async function homeMulti(servoList, name) {
            if(!port) { alert('è«‹å…ˆé€£æ¥'); return; }
            if(servoList.length===0) return;
            let cmd = `S MULTI 30 ${servoList.length}`;
            for(let s of servoList) {
                cmd += ` ${s.group}${s.id} ${s.home}`;
                const inp = document.getElementById(`input_${s.group}_${s.id}`);
                if(inp) inp.value = s.home;
                currentAngles[`${s.group}_${s.id}`] = s.home;
            }
            await sendRaw(cmd);
            addLog(`ğŸ  ${name} HOME (S MULTI 30) å®Œæˆ`,'received');
        }

        // ========== è„«åŠ›åŠŸèƒ½ (åƒ…é ­/é›™æ‰‹/é›™è…³, ç„¡å…¨èº«) ==========
        async function freePart(servoList, partName) {
            if(!port) { alert('è«‹å…ˆé€£æ¥'); return; }
            for(let s of servoList) {
                await sendRaw(`FREE ${s.group} ${s.id}`);
                await delay(15);
            }
            addLog(`ğŸ’¤ ${partName} è„«åŠ›å®Œæˆ`,'received');
        }

        // è„«åŠ›å„éƒ¨ä½ (ç„¡å…¨èº«)
        async function freeHead() { await freePart(SERVOS.filter(s=>s.part==='head'), 'é ­éƒ¨'); }
        async function freeHand() { await freePart(SERVOS.filter(s=>s.part==='rhand'||s.part==='lhand'), 'é›™æ‰‹'); }
        async function freeLeg()  { await freePart(SERVOS.filter(s=>s.part==='rleg'||s.part==='lleg'), 'é›™è…³'); }

        // ========== é•·æŒ‰é‚è¼¯ ==========
        function startRepeat(s, delta) {
            if(repeatTimer) clearInterval(repeatTimer);
            activeServo = s; activeDelta = delta; isKeyHeld = true;
            window.sendDelta(s.group, s.id, delta);
            repeatTimer = setInterval(()=>{
                if(isKeyHeld && activeServo) window.sendDelta(activeServo.group, activeServo.id, activeDelta);
            },200);
        }
        function stopRepeat() { isKeyHeld=false; activeServo=null; if(repeatTimer) { clearInterval(repeatTimer); repeatTimer=null; } }

        // ========== éµç›¤äº‹ä»¶ (ç„¡ä¸Šæ–¹æç¤º) ==========
        document.addEventListener('keydown', (e) => {
            const k = e.key;
            if(document.activeElement?.tagName==='INPUT') return;

            // è„«åŠ›å¿«æ·éµ 8 9 10
            if(k === '8') { e.preventDefault(); freeHead(); return; }
            if(k === '9') { e.preventDefault(); freeHand(); return; }
            if(k === '10' || k === '0') { e.preventDefault(); freeLeg(); return; } // 10å¯èƒ½ç•¶ä½œ0, ä½†ç”¨æ•¸å­—éµç›¤0

            // éƒ¨ä½å¿«æ· (ç„¡æç¤º)
            if(k === '1') { renderPanel('head'); e.preventDefault(); return; }
            if(k === '2') { renderPanel('hand'); e.preventDefault(); return; }
            if(k === '3') { renderPanel('leg'); e.preventDefault(); return; }
            if(k === '4') { homeAllFunc(); e.preventDefault(); return; }
            if(k === '5') { homeHeadFunc(); e.preventDefault(); return; }
            if(k === '6') { homeHandFunc(); e.preventDefault(); return; }
            if(k === '7') { homeLegFunc(); e.preventDefault(); return; }

            if(k === 'ArrowUp' || k === 'ArrowDown') {
                e.preventDefault();
                if(selectedServo) window.adjustSp(selectedServo.group, selectedServo.id, k==='ArrowUp'?5:-5);
                return;
            }

            const list = SERVOS.filter(s => 
                s.part === currentPart || 
                (currentPart==='hand' && (s.part==='rhand'||s.part==='lhand')) ||
                (currentPart==='leg' && (s.part==='rleg'||s.part==='lleg'))
            );
            const s = list.find(s=>s.shortKey.dec===k || s.shortKey.inc===k);
            if(s) {
                e.preventDefault();
                const otherKey = (k===s.shortKey.dec) ? s.shortKey.inc : s.shortKey.dec;
                if(pressedKeys.has(otherKey)) {
                    stopRepeat();
                    sendExactAngle(s.group, s.id, s.home);  // HOMEçµ„åˆéµ
                } else {
                    selectedServo = s;
                    highlightSelected();
                    const delta = (k===s.shortKey.dec) ? -50 : 50;
                    startRepeat(s, delta);
                }
                pressedKeys.add(k);
            }
        });

        document.addEventListener('keyup', (e) => {
            pressedKeys.delete(e.key);
            if(pressedKeys.size===0) stopRepeat();
        });
        window.addEventListener('blur', ()=>{ pressedKeys.clear(); stopRepeat(); });

        // ========== HOME åŒ…è£ ==========
        function homeAllFunc() { homeMulti(SERVOS, 'å…¨éƒ¨'); }
        function homeHeadFunc() { homeMulti(SERVOS.filter(s=>s.part==='head'), 'é ­éƒ¨'); }
        function homeHandFunc() { homeMulti(SERVOS.filter(s=>s.part==='rhand'||s.part==='lhand'), 'æ‰‹éƒ¨'); }
        function homeLegFunc() { homeMulti(SERVOS.filter(s=>s.part==='rleg'||s.part==='lleg'), 'è…³éƒ¨'); }

        // ========== ä¸²å£ ==========
        async function connectSerial() {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate:115200 });
                document.getElementById('status').innerHTML='âœ… å·²é€£æ¥';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                addLog('âœ… ä¸²å£å·²é€£æ¥','received');
                readLoop();
            } catch(e) { addLog(`âŒ é€£æ¥å¤±æ•—: ${e.message}`,'error'); }
        }
        async function disconnectSerial() {
            if(reader) { try{await reader.cancel();}catch(e){} reader=null; }
            if(port) { try{await port.close();}catch(e){} port=null; }
            document.getElementById('status').innerHTML='âš¡ æœªé€£æ¥';
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            addLog('ğŸ”Œ å·²æ–·é–‹','received');
        }
        async function readLoop() {
            if(!port) return;
            try {
                reader = port.readable.getReader();
                const dec = new TextDecoder();
                let buf='';
                while(true) {
                    const {value,done}=await reader.read();
                    if(done) break;
                    if(value) {
                        buf+=dec.decode(value);
                        let lines=buf.split('\n');
                        buf=lines.pop();
                        for(let l of lines) {
                            l=l.trim(); if(!l) continue;
                            addLog('ğŸ“¥ '+l,'received');
                            if(l.includes('åŠ é€Ÿåº¦')||l.includes('é™€èº')) addGyro(l);
                            const m = l.match(/([HM]V) ID (\d+).*?(\d+)/);
                            if(m) {
                                let g=m[1], id=parseInt(m[2]), ang=parseInt(m[3]);
                                const inp = document.getElementById(`input_${g}_${id}`);
                                if(inp && Math.abs(parseInt(inp.value)-ang)>10) { inp.value=ang; currentAngles[`${g}_${id}`]=ang; }
                            }
                        }
                    }
                }
            } catch(e) { addLog(`âŒ è®€å–éŒ¯èª¤ ${e.message}`,'error'); }
            finally { if(reader) { reader.releaseLock(); reader=null; } }
        }
        async function scanServos() {
            if(!port) { alert('è«‹å…ˆé€£æ¥'); return; }
            addLog('ğŸ” æƒææ‰€æœ‰ä¼ºæœ','sent');
            for(let i=1;i<=11;i++) { await sendRaw(`? MV ${i}`); await delay(30); }
            for(let i=1;i<=14;i++) { await sendRaw(`? HV ${i}`); await delay(30); }
        }
        async function testConnection() { if(port) await sendRaw('? MV 1'); else alert('å…ˆé€£æ¥'); }
        async function queryGyro() { if(port) { await sendRaw('G'); addGyro('ğŸ“Š æŸ¥è©¢é™€èºå„€'); } }

        // ========== åˆå§‹åŒ– ==========
        window.onload = function() {
            renderPanel('head');
            document.getElementById('navHead').onclick = ()=>renderPanel('head');
            document.getElementById('navHand').onclick = ()=>renderPanel('hand');
            document.getElementById('navLeg').onclick = ()=>renderPanel('leg');

            document.getElementById('connectBtn').onclick = connectSerial;
            document.getElementById('disconnectBtn').onclick = disconnectSerial;
            document.getElementById('scanBtn').onclick = scanServos;
            document.getElementById('testBtn').onclick = testConnection;

            document.getElementById('homeAllBtn').onclick = homeAllFunc;
            document.getElementById('homeHeadBtn').onclick = homeHeadFunc;
            document.getElementById('homeHandBtn').onclick = homeHandFunc;
            document.getElementById('homeLegBtn').onclick = homeLegFunc;

            // è„«åŠ›æŒ‰éˆ• (ç„¡å…¨èº«)
            document.getElementById('freeHeadBtn').onclick = freeHead;
            document.getElementById('freeHandBtn').onclick = freeHand;
            document.getElementById('freeLegBtn').onclick = freeLeg;

            document.getElementById('clearLogBtn').onclick = ()=>document.getElementById('logContent').innerHTML = '[ç³»çµ±] è¨˜éŒ„å·²æ¸…é™¤';
            document.getElementById('clearGyroBtn').onclick = ()=>document.getElementById('gyroContent').innerHTML = 'ç­‰å¾…é™€èºå„€æ•¸æ“šâ€¦';

            // åŠ å…¥é™€èºå„€æŒ‰éˆ• (é›–ç„¶ä»‹é¢æ²’æœ‰ï¼Œä½†å¯é¸)
            // è‹¥éœ€è¦å¯è‡ªåŠ 
        };
    })();
</script>
</body>
</html>
