<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ—ãƒªãƒ¡ã‚¤ãƒ‰AI 25è»¸æ§åˆ¶å™¨ - å®Œæ•´ç‰ˆ</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
        }
        body {
            background: #1a1a2e;
            color: #fff;
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        h1 {
            color: #00d4ff;
            text-align: center;
            margin: 0 0 10px 0;
            font-size: 1.8em;
            flex-shrink: 0;
        }
        h1 small {
            font-size: 14px;
            color: #888;
            display: block;
        }
        
        /* å¿«æ·éµæç¤ºæ¬„ */
        .shortcuts-bar {
            background: #16213e;
            padding: 8px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            border: 1px solid #00d4ff33;
            flex-shrink: 0;
        }
        .shortcut-group {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .shortcut-item {
            display: flex;
            align-items: center;
            gap: 5px;
            background: #0f3460;
            padding: 4px 10px;
            border-radius: 20px;
        }
        .key {
            background: #00d4ff;
            color: #1a1a2e;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            font-family: monospace;
            font-size: 13px;
            min-width: 26px;
            text-align: center;
        }
        .key.home { background: #ffaa00; }
        .key.gyro { background: #9b59b6; }
        .key.part { background: #3498db; }
        .key.speed { background: #ff4444; }
        
        /* é ‚éƒ¨æ§åˆ¶åˆ— */
        .top-control-bar {
            background: #16213e;
            border-radius: 8px;
            padding: 10px 20px;
            margin-bottom: 10px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        .btn {
            background: #00d4ff;
            color: #1a1a2e;
            border: none;
            padding: 6px 14px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            transition: 0.2s;
        }
        .btn:hover {
            background: #00b8e6;
            transform: scale(1.02);
        }
        .btn-danger {
            background: #ff4444;
            color: white;
        }
        .btn-success {
            background: #00cc66;
            color: white;
        }
        .btn-warning {
            background: #ffaa00;
            color: black;
        }
        .btn-home {
            background: #ffaa00;
            color: black;
        }
        .btn-home-all {
            background: #ffaa00;
            color: black;
        }
        .btn-gyro {
            background: #9b59b6;
            color: white;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .status {
            flex: 1;
            padding: 5px 12px;
            background: #0f3460;
            border-radius: 5px;
            font-family: monospace;
            font-size: 13px;
            min-width: 180px;
        }
        .separator {
            width: 1px;
            height: 24px;
            background: #0f3460;
            margin: 0 5px;
        }
        .selected-servo-hint {
            background: #9b59b6;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        /* ä¸»å€åŸŸ */
        .main-layout {
            display: flex;
            gap: 12px;
            flex: 1;
            min-height: 0;
            margin-bottom: 10px;
        }
        
        /* å·¦å´ */
        .robot-diagram {
            width: 220px;
            background: #16213e;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .robot-title {
            color: #00d4ff;
            font-size: 1em;
            margin-bottom: 12px;
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 1px solid #0f3460;
        }
        .part-button {
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            text-align: center;
            transition: 0.2s;
        }
        .part-button.head {
            background: #9b59b6;
            color: white;
        }
        .part-button.hand {
            background: #3498db;
            color: white;
        }
        .part-button.leg {
            background: #e67e22;
            color: white;
        }
        .part-button.active {
            border-color: #00d4ff;
            box-shadow: 0 0 15px #00d4ff;
        }
        .part-key {
            font-size: 0.8em;
            margin-top: 5px;
            color: rgba(255,255,255,0.7);
        }
        
        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            flex: 1;
            background: #16213e;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #0f3460;
            flex-shrink: 0;
        }
        .panel-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #00d4ff;
        }
        .panel-meta {
            background: #0f3460;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75em;
        }
        
        /* ä¼ºæœå®¹å™¨ */
        .servo-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        /* å·¦å³åˆ†æ¬„ */
        .split-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            height: 100%;
        }
        .split-left, .split-right {
            display: flex;
            flex-direction: column;
            gap: 6px;
            overflow-y: auto;
            padding-right: 5px;
        }
        .split-title {
            color: #888;
            font-size: 0.85em;
            text-align: center;
            padding: 4px;
            background: #0f3460;
            border-radius: 4px;
            flex-shrink: 0;
        }
        
        /* ä¼ºæœåˆ— */
        .servo-row {
            background: #0f3460;
            border-radius: 6px;
            padding: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            border-left: 4px solid;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .servo-row.mv-row {
            border-left-color: #00d4ff;
        }
        .servo-row.hv-row {
            border-left-color: #ffaa00;
        }
        .servo-row.active-dec {
            background: #ff4444 !important;
            box-shadow: 0 0 15px #ff4444;
        }
        .servo-row.active-inc {
            background: #00cc66 !important;
            box-shadow: 0 0 15px #00cc66;
        }
        .servo-row.active-home {
            background: #ffaa00 !important;
            box-shadow: 0 0 15px #ffaa00;
        }
        .servo-row.active-speed {
            background: #ffaa00 !important;
            box-shadow: 0 0 20px #ffaa00;
        }
        .servo-row.selected {
            border: 2px solid #00d4ff;
        }
        
        /* ä¼ºæœè³‡è¨Š */
        .servo-info {
            flex: 2;
            min-width: 90px;
        }
        .servo-name {
            font-weight: bold;
            font-size: 0.85em;
            white-space: nowrap;
        }
        .servo-detail {
            font-size: 0.65em;
            color: #888;
            display: flex;
            gap: 4px;
            align-items: center;
            flex-wrap: wrap;
        }
        .pma-id {
            background: #00d4ff22;
            color: #00d4ff;
            padding: 1px 4px;
            border-radius: 8px;
        }
        .shortkey-badge {
            background: #00d4ff;
            color: #1a1a2e;
            padding: 1px 4px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: bold;
            cursor: pointer;
        }
        .shortkey-badge:hover {
            background: #ffaa00;
        }
        .home-star {
            color: #ffaa00;
            font-weight: bold;
        }
        
        /* æ§åˆ¶åŒ…è£ */
        .controls-wrapper {
            flex: 3;
            display: flex;
            gap: 6px;
            justify-content: flex-end;
        }
        
        /* è§’åº¦æ§åˆ¶ */
        .angle-control {
            display: flex;
            align-items: center;
            gap: 3px;
            background: #1a1a2e;
            padding: 2px 4px;
            border-radius: 4px;
            border-left: 2px solid #00d4ff;
        }
        .angle-label {
            color: #00d4ff;
            font-size: 0.65em;
            font-weight: bold;
        }
        .btn-angle {
            background: #0f3460;
            color: #00d4ff;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-angle:hover {
            background: #00d4ff;
            color: #1a1a2e;
        }
        .angle-input {
            background: #1a1a2e;
            color: #00d4ff;
            border: 1px solid #00d4ff;
            border-radius: 3px;
            padding: 2px 3px;
            font-family: monospace;
            font-size: 0.85em;
            width: 65px;
            text-align: center;
            outline: none;
            transition: all 0.2s;
        }
        .angle-input:focus {
            border-color: #ffaa00;
            box-shadow: 0 0 5px #ffaa00;
        }
        
        /* é€Ÿåº¦æ§åˆ¶ */
        .speed-control {
            display: flex;
            align-items: center;
            gap: 3px;
            background: #1a1a2e;
            padding: 2px 4px;
            border-radius: 4px;
            border-left: 2px solid #ffaa00;
        }
        .speed-label {
            color: #ffaa00;
            font-size: 0.65em;
            font-weight: bold;
        }
        .btn-speed {
            background: #0f3460;
            color: #ffaa00;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .btn-speed:hover {
            background: #ffaa00;
            color: #1a1a2e;
        }
        .speed-input {
            background: #1a1a2e;
            color: #ffaa00;
            border: 1px solid #ffaa00;
            border-radius: 3px;
            padding: 2px 3px;
            font-family: monospace;
            font-size: 0.85em;
            width: 45px;
            text-align: center;
            outline: none;
            transition: all 0.2s;
        }
        .speed-input:focus {
            border-color: #00d4ff;
            box-shadow: 0 0 5px #00d4ff;
        }
        
        /* é€Ÿåº¦æ”¹è®Šå‹•ç•« */
        .speed-input.speed-changed {
            background-color: #ffaa00 !important;
            color: #1a1a2e !important;
            transition: all 0.2s;
        }
        
        @keyframes speedPulse {
            0% { background-color: #ffaa00; color: #1a1a2e; transform: scale(1); }
            50% { background-color: #ffaa00; color: #1a1a2e; transform: scale(1.05); }
            100% { background-color: #1a1a2e; color: #ffaa00; transform: scale(1); }
        }
        
        .speed-pulse {
            animation: speedPulse 0.3s ease;
        }
        
        /* åº•éƒ¨å€åŸŸ */
        .bottom-section {
            display: flex;
            gap: 12px;
            flex-shrink: 0;
            height: 150px;
        }
        
        /* GYROå€åŸŸ */
        .gyro-section {
            flex: 1;
            background: #16213e;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .gyro-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            flex-shrink: 0;
        }
        .gyro-title {
            color: #9b59b6;
            font-size: 0.95em;
            font-weight: bold;
        }
        .gyro-content {
            flex: 1;
            background: #0f3460;
            border-radius: 6px;
            padding: 6px;
            font-family: monospace;
            font-size: 11px;
            color: #9b59b6;
            overflow-y: auto;
            line-height: 1.4;
        }
        
        /* LOGå€åŸŸ */
        .log-section {
            flex: 1;
            background: #16213e;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            flex-shrink: 0;
        }
        .log-title {
            color: #00d4ff;
            font-size: 0.95em;
            font-weight: bold;
        }
        .log-content {
            flex: 1;
            background: #0f3460;
            border-radius: 6px;
            padding: 6px;
            font-family: monospace;
            font-size: 10px;
            color: #00d4ff;
            overflow-y: auto;
        }
        .log-sent { color: #00d4ff; }
        .log-received { color: #00cc66; }
        
        /* æ»¾å‹•æ¢ */
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: #0f3460;
        }
        ::-webkit-scrollbar-thumb {
            background: #00d4ff;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– ãƒ—ãƒªãƒ¡ã‚¤ãƒ‰AI 25è»¸æ§åˆ¶å™¨ <small>é€Ÿåº¦:0-127(0æœ€æ…¢ 127æœ€å¿«)</small></h1>
        
        <div class="shortcuts-bar">
            <div class="shortcut-group">
                <span class="key part">1</span> é ­
                <span class="key part">2</span> æ‰‹
                <span class="key part">3</span> è…³
                <span class="key home">4</span> å…¨HOME
                <span class="key home">5</span> é ­HOME
                <span class="key home">6</span> æ‰‹HOME
                <span class="key home">7</span> è…³HOME
                <span class="key gyro">8</span> GYRO
            </div>
            <div class="shortcut-group">
                <span class="key speed">q/w/e/r</span>
                <span style="color:#ffaa00;">é¸ä¼ºæœ</span>
                <span class="key" style="background:#ffaa00;">â†‘â†“</span>
                <span style="color:#ffaa00;">èª¿é€Ÿ</span>
            </div>
        </div>

        <div class="top-control-bar">
            <button class="btn" id="connectBtn">ğŸ”Œ é€£æ¥</button>
            <button class="btn btn-danger" id="disconnectBtn" disabled>âŒ æ–·é–‹</button>
            <button class="btn btn-warning" id="scanBtn">ğŸ” æƒæ</button>
            <button class="btn btn-success" id="testBtn">ğŸ“¡ æ¸¬è©¦</button>
            
            <div class="separator"></div>
            
            <button class="btn btn-home-all" id="homeAllBtn">ğŸ  å…¨éƒ¨(4)</button>
            <button class="btn btn-home" id="homeHeadBtn">ğŸ‘¤ é ­(5)</button>
            <button class="btn btn-home" id="homeHandBtn">ğŸ–ï¸ æ‰‹(6)</button>
            <button class="btn btn-home" id="homeLegBtn">ğŸ¦¶ è…³(7)</button>
            <button class="btn" id="homeCurrentBtn" style="background: #95a5a6;">ğŸ“Œ å„²å­˜HOME</button>
            
            <div class="separator"></div>
            
            <button class="btn btn-gyro" id="gyroBtn">ğŸ“Š GYRO(8)</button>
            
            <div class="status" id="status">âš¡ æœªé€£æ¥</div>
            <div class="selected-servo-hint" id="selectedServoHint">âš¡ æœªé¸æ“‡ä¼ºæœ</div>
        </div>

        <div class="main-layout">
            <div class="robot-diagram">
                <div class="robot-title">éƒ¨ä½ (1-3)</div>
                <button class="part-button head active" id="selectHead">
                    ğŸ‘¤ é ­éƒ¨(3è»¸) <span class="part-key">1</span>
                </button>
                <button class="part-button hand" id="selectHand">
                    ğŸ–ï¸ æ‰‹éƒ¨(10è»¸) <span class="part-key">2</span>
                </button>
                <button class="part-button leg" id="selectLeg">
                    ğŸ¦¶ è…³éƒ¨(12è»¸) <span class="part-key">3</span>
                </button>
            </div>

            <div class="control-panel" id="controlPanel">
                <div class="panel-header">
                    <span class="panel-title" id="panelTitle">ğŸ‘¤ é ­éƒ¨æ§åˆ¶</span>
                    <span class="panel-meta" id="panelMeta"></span>
                </div>
                <div class="servo-container" id="servoContainer"></div>
            </div>
        </div>

        <div class="bottom-section">
            <div class="gyro-section">
                <div class="gyro-header">
                    <div class="gyro-title">ğŸ“Š é™€èºå„€(8)</div>
                    <button class="btn" id="clearGyroBtn" style="padding: 3px 10px; font-size: 11px;">æ¸…é™¤</button>
                </div>
                <div class="gyro-content" id="gyroContent">ç­‰å¾…é™€èºå„€æ•¸æ“š...</div>
            </div>

            <div class="log-section">
                <div class="log-header">
                    <div class="log-title">ğŸ“‹ è¨˜éŒ„</div>
                    <button class="btn" id="clearLogBtn" style="padding: 3px 10px; font-size: 11px;">æ¸…é™¤</button>
                </div>
                <div class="log-content" id="logContent">[ç³»çµ±] åˆå§‹åŒ–å®Œæˆ<br>[ç³»çµ±] é€Ÿåº¦:0-127</div>
            </div>
        </div>
    </div>

    <script>
        const SERVOS = [
            { id:1, pmaId:'02', name:'é ­ãƒ”ãƒƒãƒ', nameZh:'é ­éƒ¨ä¿¯ä»°', min:7200, max:8400, home:7500, group:'MV', part:'head', shortKey:{ dec:'q', inc:'w' }, speed:64 },
            { id:2, pmaId:'03', name:'é ­ãƒ¨ãƒ¼', nameZh:'é ­éƒ¨å·¦å³', min:5000, max:10000, home:7500, group:'MV', part:'head', shortKey:{ dec:'e', inc:'r' }, speed:64 },
            { id:3, pmaId:'07', name:'é ­èŒ', nameZh:'é ­éƒ¨èŒ', min:6900, max:8100, home:7500, group:'MV', part:'head', shortKey:{ dec:'t', inc:'y' }, speed:64 },
            { id:1, pmaId:'02', name:'è‚©ãƒ”ãƒƒãƒR', nameZh:'å³è‚© pitch', min:4300, max:11500, home:10200, group:'HV', part:'rhand', shortKey:{ dec:'q', inc:'w' }, speed:64 },
            { id:4, pmaId:'09', name:'è‚©ãƒ­ãƒ¼ãƒ«R', nameZh:'å³è‚© roll', min:7450, max:10350, home:9800, group:'MV', part:'rhand', shortKey:{ dec:'e', inc:'r' }, speed:64 },
            { id:6, pmaId:'0D', name:'ä¸Šè…•ãƒ¨ãƒ¼R', nameZh:'å³ä¸Šè‡‚ yaw', min:4000, max:11000, home:7500, group:'MV', part:'rhand', shortKey:{ dec:'t', inc:'y' }, speed:64 },
            { id:8, pmaId:'11', name:'è‚˜ãƒ”ãƒƒãƒR', nameZh:'å³è‚˜ pitch', min:7100, max:11000, home:7500, group:'MV', part:'rhand', shortKey:{ dec:'u', inc:'i' }, speed:64 },
            { id:10, pmaId:'15', name:'æ‰‹é¦–ãƒ¨ãƒ¼R', nameZh:'å³æ‰‹è…• yaw', min:3500, max:11500, home:5000, group:'MV', part:'rhand', shortKey:{ dec:'o', inc:'p' }, speed:64 },
            { id:2, pmaId:'04', name:'è‚©ãƒ”ãƒƒãƒL', nameZh:'å·¦è‚© pitch', min:3500, max:10700, home:4700, group:'HV', part:'lhand', shortKey:{ dec:'a', inc:'s' }, speed:64 },
            { id:5, pmaId:'0B', name:'è‚©ãƒ­ãƒ¼ãƒ«L', nameZh:'å·¦è‚© roll', min:4550, max:7550, home:5200, group:'MV', part:'lhand', shortKey:{ dec:'d', inc:'f' }, speed:64 },
            { id:7, pmaId:'0F', name:'ä¸Šè…•ãƒ¨ãƒ¼L', nameZh:'å·¦ä¸Šè‡‚ yaw', min:4000, max:11000, home:7500, group:'MV', part:'lhand', shortKey:{ dec:'g', inc:'h' }, speed:64 },
            { id:9, pmaId:'13', name:'è‚˜ãƒ”ãƒƒãƒL', nameZh:'å·¦è‚˜ pitch', min:4000, max:7900, home:7500, group:'MV', part:'lhand', shortKey:{ dec:'j', inc:'k' }, speed:64 },
            { id:11, pmaId:'17', name:'æ‰‹é¦–ãƒ¨ãƒ¼L', nameZh:'å·¦æ‰‹è…• yaw', min:3500, max:11500, home:10000, group:'MV', part:'lhand', shortKey:{ dec:'l', inc:';' }, speed:64 },
            { id:3, pmaId:'06', name:'ãƒ’ãƒƒãƒ—ãƒ¨ãƒ¼R', nameZh:'å³é«– yaw', min:6530, max:9030, home:7780, group:'HV', part:'rleg', shortKey:{ dec:'q', inc:'w' }, speed:64 },
            { id:5, pmaId:'0A', name:'ãƒ’ãƒƒãƒ—ãƒ­ãƒ¼ãƒ«R', nameZh:'å³é«– roll', min:6700, max:8300, home:7500, group:'HV', part:'rleg', shortKey:{ dec:'e', inc:'r' }, speed:64 },
            { id:7, pmaId:'0E', name:'è…¿ãƒ”ãƒƒãƒR', nameZh:'å³å¤§è…¿ pitch', min:4700, max:10200, home:7500, group:'HV', part:'rleg', shortKey:{ dec:'t', inc:'y' }, speed:64 },
            { id:9, pmaId:'12', name:'è†ãƒ”ãƒƒãƒR', nameZh:'å³è† pitch', min:3950, max:7600, home:7500, group:'HV', part:'rleg', shortKey:{ dec:'u', inc:'i' }, speed:64 },
            { id:11, pmaId:'16', name:'è¶³é¦–ãƒ”ãƒƒãƒR', nameZh:'å³è¸ pitch', min:5700, max:8300, home:7500, group:'HV', part:'rleg', shortKey:{ dec:'o', inc:'p' }, speed:64 },
            { id:13, pmaId:'1A', name:'è¶³é¦–ãƒ­ãƒ¼ãƒ«R', nameZh:'å³è¸ roll', min:6800, max:9150, home:7725, group:'HV', part:'rleg', shortKey:{ dec:'[', inc:']' }, speed:64 },
            { id:4, pmaId:'08', name:'ãƒ’ãƒƒãƒ—ãƒ¨ãƒ¼L', nameZh:'å·¦é«– yaw', min:6250, max:8750, home:7500, group:'HV', part:'lleg', shortKey:{ dec:'a', inc:'s' }, speed:64 },
            { id:6, pmaId:'0C', name:'ãƒ’ãƒƒãƒ—ãƒ­ãƒ¼ãƒ«L', nameZh:'å·¦é«– roll', min:6700, max:8300, home:7500, group:'HV', part:'lleg', shortKey:{ dec:'d', inc:'f' }, speed:64 },
            { id:8, pmaId:'10', name:'è…¿ãƒ”ãƒƒãƒL', nameZh:'å·¦å¤§è…¿ pitch', min:4700, max:10200, home:7500, group:'HV', part:'lleg', shortKey:{ dec:'g', inc:'h' }, speed:64 },
            { id:10, pmaId:'14', name:'è†ãƒ”ãƒƒãƒL', nameZh:'å·¦è† pitch', min:7400, max:11050, home:7500, group:'HV', part:'lleg', shortKey:{ dec:'j', inc:'k' }, speed:64 },
            { id:12, pmaId:'18', name:'è¶³é¦–ãƒ”ãƒƒãƒL', nameZh:'å·¦è¸ pitch', min:6750, max:9350, home:7500, group:'HV', part:'lleg', shortKey:{ dec:'l', inc:';' }, speed:64 },
            { id:14, pmaId:'1C', name:'è¶³é¦–ãƒ­ãƒ¼ãƒ«L', nameZh:'å·¦è¸ roll', min:6200, max:8450, home:7500, group:'HV', part:'lleg', shortKey:{ dec:'\'', inc:'\\' }, speed:64 }
        ];

        let currentPart = 'head';
        let port = null;
        let reader = null;
        let currentAngles = {};
        let selectedServo = null;
        let pressedKeys = new Set();
        
        // é•·æŒ‰é‡è¤‡ç™¼é€
        let repeatTimer = null;
        let activeServo = null;
        let activeDelta = 0;
        let isKeyHeld = false;

        function addLog(msg, type='info') {
            const log = document.getElementById('logContent');
            const time = new Date().toLocaleTimeString();
            const cls = type==='sent'?'log-sent':type==='received'?'log-received':'';
            log.innerHTML += `<div><span class="${cls}">[${time}] ${msg}</span></div>`;
            log.scrollTop = log.scrollHeight;
            if(log.children.length>30) log.removeChild(log.firstChild);
        }

        function addGyroLog(msg) {
            const gyro = document.getElementById('gyroContent');
            const time = new Date().toLocaleTimeString();
            gyro.innerHTML += `<div>[${time}] ${msg}</div>`;
            gyro.scrollTop = gyro.scrollHeight;
            if(gyro.children.length>8) gyro.removeChild(gyro.firstChild);
        }

        function setupInputSelection() {
            document.querySelectorAll('.angle-input, .speed-input').forEach(input => {
                input.addEventListener('click', function(){ this.select(); });
                input.addEventListener('focus', function(){ this.select(); });
            });
        }

        function updatePanel(part) {
            currentPart = part;
            const titles = {
                head:{ title:'ğŸ‘¤ é ­éƒ¨æ§åˆ¶', meta:'å¿«æ·éµ: QW/ER/TY' },
                hand:{ title:'ğŸ–ï¸ æ‰‹éƒ¨æ§åˆ¶', meta:'å³æ‰‹:QW/ER/TY/UI/OP  å·¦æ‰‹:AS/DF/GH/JK/L;' },
                leg:{ title:'ğŸ¦¶ è…³éƒ¨æ§åˆ¶', meta:'å³è…³:QW/ER/TY/UI/OP/[]  å·¦è…³:AS/DF/GH/JK/L;/\'' }
            };
            document.getElementById('panelTitle').textContent = titles[part].title;
            document.getElementById('panelMeta').textContent = titles[part].meta;
            
            document.querySelectorAll('.part-button').forEach(btn=>btn.classList.remove('active'));
            document.getElementById(`select${part.charAt(0).toUpperCase()+part.slice(1)}`).classList.add('active');
            
            let html = '';
            if(part==='head'){
                SERVOS.filter(s=>s.part==='head').forEach(s=>html+=createServoRow(s));
            }else if(part==='hand'){
                html='<div class="split-panel"><div class="split-left"><div class="split-title">ğŸ‘‰ å³æ‰‹</div>';
                SERVOS.filter(s=>s.part==='rhand').forEach(s=>html+=createServoRow(s));
                html+='</div><div class="split-right"><div class="split-title">ğŸ‘ˆ å·¦æ‰‹</div>';
                SERVOS.filter(s=>s.part==='lhand').forEach(s=>html+=createServoRow(s));
                html+='</div></div>';
            }else{
                html='<div class="split-panel"><div class="split-left"><div class="split-title">ğŸ¦¶ å³è…³</div>';
                SERVOS.filter(s=>s.part==='rleg').forEach(s=>html+=createServoRow(s));
                html+='</div><div class="split-right"><div class="split-title">ğŸ¦¶ å·¦è…³</div>';
                SERVOS.filter(s=>s.part==='lleg').forEach(s=>html+=createServoRow(s));
                html+='</div></div>';
            }
            document.getElementById('servoContainer').innerHTML = html;
            
            document.querySelectorAll('.angle-input').forEach(input=>{
                input.addEventListener('keypress',e=>{ if(e.key==='Enter'){ e.preventDefault(); input.blur(); } });
                input.addEventListener('blur',e=>{
                    const g=input.dataset.group, id=parseInt(input.dataset.id), a=parseInt(input.value);
                    if(!isNaN(a)) sendExactAngle(g,id,a);
                    else{ const s=SERVOS.find(s=>s.group===g&&s.id===id); if(s) input.value=currentAngles[`${g}_${id}`]||s.home; }
                });
            });
            
            document.querySelectorAll('.speed-input').forEach(input=>{
                input.addEventListener('keypress',e=>{ if(e.key==='Enter'){ e.preventDefault(); input.blur(); } });
                input.addEventListener('blur',e=>{
                    const g=input.dataset.group, id=parseInt(input.dataset.id), sp=parseInt(input.value);
                    if(!isNaN(sp)&&sp>=0&&sp<=127) sendExactSpeed(g,id,sp);
                    else{ const s=SERVOS.find(s=>s.group===g&&s.id===id); if(s) input.value=s.speed; }
                });
            });
            
            setupInputSelection();
            if(selectedServo) highlightSelectedServo();
        }

        function createServoRow(s){
            const isSpecial = s.home!==7500;
            const saved = currentAngles[`${s.group}_${s.id}`]||s.home;
            const dec = s.shortKey.dec==='\''?'\'':s.shortKey.dec;
            const inc = s.shortKey.inc==='\\'?'\\':s.shortKey.inc;
            return `<div class="servo-row ${s.group.toLowerCase()}-row" id="row_${s.group}_${s.id}" data-group="${s.group}" data-id="${s.id}">
                <div class="servo-info">
                    <div class="servo-name">${s.nameZh}</div>
                    <div class="servo-detail">
                        <span class="pma-id">PMA ${s.pmaId}</span>
                        <span>${s.group} ID:${s.id}</span>
                        ${isSpecial?'<span class="home-star">â˜…</span>':''}
                        <span class="shortkey-badge" onclick="selectServoByKey('${s.shortKey.dec}')">${dec}</span>
                        <span class="shortkey-badge" onclick="selectServoByKey('${s.shortKey.inc}')">${inc}</span>
                    </div>
                </div>
                <div class="controls-wrapper">
                    <div class="angle-control">
                        <span class="angle-label">è§’</span>
                        <button class="btn-angle" onclick="sendAngle('${s.group}',${s.id},-50)">âˆ’</button>
                        <input type="text" class="angle-input" id="input_${s.group}_${s.id}" value="${saved}" data-group="${s.group}" data-id="${s.id}">
                        <button class="btn-angle" onclick="sendAngle('${s.group}',${s.id},50)">+</button>
                    </div>
                    <div class="speed-control">
                        <span class="speed-label">é€Ÿ</span>
                        <button class="btn-speed" onclick="adjustSpeed('${s.group}',${s.id},-5)">âˆ’</button>
                        <input type="text" class="speed-input" id="speed_${s.group}_${s.id}" value="${s.speed}" data-group="${s.group}" data-id="${s.id}">
                        <button class="btn-speed" onclick="adjustSpeed('${s.group}',${s.id},5)">+</button>
                    </div>
                </div>
            </div>`;
        }

        function selectServo(s){
            if(selectedServo){
                const r=document.getElementById(`row_${selectedServo.group}_${selectedServo.id}`);
                if(r) r.classList.remove('selected');
            }
            selectedServo=s;
            highlightSelectedServo();
            document.getElementById('selectedServoHint').innerHTML=`âš¡ é¸ä¸­: ${s.nameZh} (${s.group} ID:${s.id}) é€Ÿåº¦:${s.speed}`;
        }

        function highlightSelectedServo(){
            if(!selectedServo) return;
            const r=document.getElementById(`row_${selectedServo.group}_${selectedServo.id}`);
            if(r) r.classList.add('selected');
        }

        function selectServoByKey(key){
            const list=SERVOS.filter(s=>s.part===currentPart||(currentPart==='hand'&&(s.part==='rhand'||s.part==='lhand'))||(currentPart==='leg'&&(s.part==='rleg'||s.part==='lleg')));
            const s=list.find(s=>s.shortKey.dec===key||s.shortKey.inc===key);
            if(s){ selectServo(s); addLog(`âœ… å·²é¸ä¸­: ${s.nameZh}`,'info'); return true; }
            return false;
        }

        // èª¿æ•´é€Ÿåº¦ - åŠ å…¥é¡è‰²åé¥‹
        function adjustSpeed(group,id,delta){
            const s=SERVOS.find(s=>s.group===group&&s.id===id);
            if(!s) return;
            let ns=s.speed+delta;
            if(ns<0) ns=0; if(ns>127) ns=127;
            if(ns!==s.speed){
                s.speed=ns;
                const inp=document.getElementById(`speed_${group}_${id}`);
                if(inp){
                    inp.value=ns;
                    inp.classList.add('speed-changed');
                    setTimeout(()=>inp.classList.remove('speed-changed'),300);
                    
                    const row=document.getElementById(`row_${group}_${id}`);
                    if(row){
                        row.classList.add('active-speed');
                        setTimeout(()=>row.classList.remove('active-speed'),300);
                    }
                }
                if(selectedServo&&selectedServo.group===group&&selectedServo.id===id){
                    const hint=document.getElementById('selectedServoHint');
                    hint.innerHTML=`âš¡ é¸ä¸­: ${s.nameZh} (${group} ID:${id}) é€Ÿåº¦:${ns}`;
                    hint.style.backgroundColor='#ffaa00';
                    hint.style.color='#1a1a2e';
                    setTimeout(()=>{ hint.style.backgroundColor=''; hint.style.color=''; },300);
                }
                addLog(`âš¡ ${s.nameZh} é€Ÿåº¦=${ns}`,'info');
                if(port) sendExactSpeed(group,id,ns);
            }
        }

        async function sendExactSpeed(g,id,sp){
            if(!port) return;
            const s=SERVOS.find(s=>s.group===g&&s.id===id);
            if(!s) return;
            if(sp<0) sp=0; if(sp>127) sp=127;
            s.speed=sp;
            addLog(`âš¡ ${s.nameZh} é€Ÿåº¦æ›´æ–°ç‚º ${sp}`,'info');
        }

        async function sendAngle(g,id,delta){
            if(!port){ addLog('âŒ æœªé€£æ¥','error'); alert('è«‹å…ˆé€£æ¥'); return; }
            const s=SERVOS.find(s=>s.group===g&&s.id===id);
            if(!s) return;
            const inp=document.getElementById(`input_${g}_${id}`);
            let cur=parseInt(inp.value);
            let na=cur+delta;
            if(na<s.min) na=s.min; if(na>s.max) na=s.max;
            if(na!==cur){
                inp.value=na;
                currentAngles[`${g}_${id}`]=na;
                const cmd=`S ${g} ${id} ${na} ${s.speed}\n`;
                try{
                    addLog(`ğŸ“¤ ${cmd.trim()} (é€Ÿ:${s.speed})`,'sent');
                    const w=port.writable.getWriter();
                    await w.write(new TextEncoder().encode(cmd));
                    w.releaseLock();
                    const r=document.getElementById(`row_${g}_${id}`);
                    if(r){
                        r.classList.add(delta<0?'active-dec':'active-inc');
                        setTimeout(()=>r.classList.remove('active-dec','active-inc'),300);
                    }
                }catch(e){ addLog(`âŒ ${e.message}`,'error'); }
            }
        }

        async function sendExactAngle(g,id,na){
            if(!port){ addLog('âŒ æœªé€£æ¥','error'); alert('è«‹å…ˆé€£æ¥'); return; }
            const s=SERVOS.find(s=>s.group===g&&s.id===id);
            if(!s) return;
            if(na<s.min) na=s.min; if(na>s.max) na=s.max;
            const inp=document.getElementById(`input_${g}_${id}`);
            inp.value=na;
            currentAngles[`${g}_${id}`]=na;
            const cmd=`S ${g} ${id} ${na} ${s.speed}\n`;
            try{
                addLog(`ğŸ“¤ ${cmd.trim()} (é€Ÿ:${s.speed})`,'sent');
                const w=port.writable.getWriter();
                await w.write(new TextEncoder().encode(cmd));
                w.releaseLock();
                const r=document.getElementById(`row_${g}_${id}`);
                if(r){
                    r.classList.add('active-home');
                    setTimeout(()=>r.classList.remove('active-home'),300);
                }
            }catch(e){ addLog(`âŒ ${e.message}`,'error'); }
        }

        async function sendHome(g,id){
            if(!port){ addLog('âŒ æœªé€£æ¥','error'); return; }
            const s=SERVOS.find(s=>s.group===g&&s.id===id);
            if(!s) return;
            const inp=document.getElementById(`input_${g}_${id}`);
            inp.value=s.home;
            currentAngles[`${g}_${id}`]=s.home;
            const cmd=`S ${g} ${id} ${s.home} ${s.speed}\n`;
            try{
                addLog(`ğŸ  HOME ${g} ID${id}=${s.home} (é€Ÿ:${s.speed})`,'sent');
                const w=port.writable.getWriter();
                await w.write(new TextEncoder().encode(cmd));
                w.releaseLock();
                const r=document.getElementById(`row_${g}_${id}`);
                if(r){
                    r.classList.add('active-home');
                    setTimeout(()=>r.classList.remove('active-home'),500);
                }
            }catch(e){ addLog(`âŒ ${e.message}`,'error'); }
        }

        // é•·æŒ‰é‡è¤‡ç™¼é€
        function startRepeatSend(s,delta){
            if(repeatTimer) clearInterval(repeatTimer);
            activeServo=s; activeDelta=delta; isKeyHeld=true;
            sendAngle(s.group,s.id,delta);
            repeatTimer=setInterval(()=>{
                if(isKeyHeld&&activeServo) sendAngle(activeServo.group,activeServo.id,activeDelta);
            },250);
        }

        function stopRepeatSend(){
            isKeyHeld=false; activeServo=null;
            if(repeatTimer){ clearInterval(repeatTimer); repeatTimer=null; }
        }

        function handleShortcut(key){
            if(key==='1'){ updatePanel('head'); return true; }
            if(key==='2'){ updatePanel('hand'); return true; }
            if(key==='3'){ updatePanel('leg'); return true; }
            if(key==='4'){ goHomeAll(); return true; }
            if(key==='5'){ goHomeHead(); return true; }
            if(key==='6'){ goHomeHand(); return true; }
            if(key==='7'){ goHomeLeg(); return true; }
            if(key==='8'){ queryGyro(); return true; }
            return false;
        }

        function findServoByKey(key){
            const list=SERVOS.filter(s=>s.part===currentPart||(currentPart==='hand'&&(s.part==='rhand'||s.part==='lhand'))||(currentPart==='leg'&&(s.part==='rleg'||s.part==='lleg')));
            return list.find(s=>s.shortKey.dec===key||s.shortKey.inc===key);
        }

        document.addEventListener('keydown',e=>{
            const k=e.key;
            if(document.activeElement.classList.contains('angle-input')||document.activeElement.classList.contains('speed-input')) return;
            if(k==='Control'||k==='Alt'||k==='Shift'||k==='Meta') return;
            if(handleShortcut(k)){ e.preventDefault(); return; }
            if(k==='ArrowUp'||k==='ArrowDown'){
                e.preventDefault();
                if(selectedServo){
                    const d=k==='ArrowUp'?5:-5;
                    const hint=document.getElementById('selectedServoHint');
                    hint.style.backgroundColor='#ffaa00';
                    hint.style.color='#1a1a2e';
                    setTimeout(()=>{ hint.style.backgroundColor=''; hint.style.color=''; },200);
                    adjustSpeed(selectedServo.group,selectedServo.id,d);
                }else addLog('âš ï¸ è«‹å…ˆé¸æ“‡ä¼ºæœ','info');
                return;
            }
            if(pressedKeys.has(k)) return;
            pressedKeys.add(k);
            const s=findServoByKey(k);
            if(s){
                e.preventDefault();
                const other=k===s.shortKey.dec?s.shortKey.inc:s.shortKey.dec;
                if(pressedKeys.has(other)){
                    stopRepeatSend();
                    sendHome(s.group,s.id);
                }else{
                    selectServo(s);
                    const d=k===s.shortKey.dec?-50:50;
                    startRepeatSend(s,d);
                }
            }
        });

        document.addEventListener('keyup',e=>{
            pressedKeys.delete(e.key);
            if(pressedKeys.size===0) stopRepeatSend();
            else{
                let active=false;
                for(let k of pressedKeys){ if(findServoByKey(k)){ active=true; break; } }
                if(!active) stopRepeatSend();
            }
        });

        window.addEventListener('blur',()=>{ pressedKeys.clear(); stopRepeatSend(); });

        async function goHomeAll(){
            addLog('ğŸ  å…¨éƒ¨HOME','sent');
            for(let s of SERVOS){
                const inp=document.getElementById(`input_${s.group}_${s.id}`);
                if(inp){ inp.value=s.home; currentAngles[`${s.group}_${s.id}`]=s.home; }
                if(port){
                    try{
                        const w=port.writable.getWriter();
                        await w.write(new TextEncoder().encode(`S ${s.group} ${s.id} ${s.home} ${s.speed}\n`));
                        w.releaseLock();
                        await delay(20);
                    }catch(e){ addLog(`âŒ ${e.message}`,'error'); }
                }
            }
        }

        async function goHomeHead(){
            addLog('ğŸ‘¤ é ­éƒ¨HOME','sent');
            for(let s of SERVOS.filter(s=>s.part==='head')){
                const inp=document.getElementById(`input_${s.group}_${s.id}`);
                if(inp){ inp.value=s.home; currentAngles[`${s.group}_${s.id}`]=s.home; }
                if(port){
                    try{
                        const w=port.writable.getWriter();
                        await w.write(new TextEncoder().encode(`S ${s.group} ${s.id} ${s.home} ${s.speed}\n`));
                        w.releaseLock();
                        await delay(20);
                    }catch(e){ addLog(`âŒ ${e.message}`,'error'); }
                }
            }
        }

        async function goHomeHand(){
            addLog('ğŸ–ï¸ æ‰‹éƒ¨HOME','sent');
            for(let s of SERVOS.filter(s=>s.part==='rhand'||s.part==='lhand')){
                const inp=document.getElementById(`input_${s.group}_${s.id}`);
                if(inp){ inp.value=s.home; currentAngles[`${s.group}_${s.id}`]=s.home; }
                if(port){
                    try{
                        const w=port.writable.getWriter();
                        await w.write(new TextEncoder().encode(`S ${s.group} ${s.id} ${s.home} ${s.speed}\n`));
                        w.releaseLock();
                        await delay(20);
                    }catch(e){ addLog(`âŒ ${e.message}`,'error'); }
                }
            }
        }

        async function goHomeLeg(){
            addLog('ğŸ¦¶ è…³éƒ¨HOME','sent');
            for(let s of SERVOS.filter(s=>s.part==='rleg'||s.part==='lleg')){
                const inp=document.getElementById(`input_${s.group}_${s.id}`);
                if(inp){ inp.value=s.home; currentAngles[`${s.group}_${s.id}`]=s.home; }
                if(port){
                    try{
                        const w=port.writable.getWriter();
                        await w.write(new TextEncoder().encode(`S ${s.group} ${s.id} ${s.home} ${s.speed}\n`));
                        w.releaseLock();
                        await delay(20);
                    }catch(e){ addLog(`âŒ ${e.message}`,'error'); }
                }
            }
        }

        function saveCurrentAsHome(){
            addLog('ğŸ“Œ å„²å­˜HOME','sent');
            SERVOS.forEach(s=>{ const i=document.getElementById(`input_${s.group}_${s.id}`); if(i) s.home=parseInt(i.value); });
            alert('HOMEå·²å„²å­˜ï¼');
        }

        async function queryGyro(){
            if(!port){ alert('è«‹å…ˆé€£æ¥'); return; }
            addLog('ğŸ“Š æŸ¥è©¢é™€èºå„€','sent');
            addGyroLog('ğŸ“Š æŸ¥è©¢é™€èºå„€...');
            await sendCommand('G');
        }

        async function testConnection(){
            if(!port){ alert('è«‹å…ˆé€£æ¥'); return; }
            addLog('ğŸ“¡ æ¸¬è©¦','sent');
            await sendAngle(SERVOS[0].group,SERVOS[0].id,0);
        }

        async function sendCommand(c){
            if(!port) return;
            try{
                const w=port.writable.getWriter();
                await w.write(new TextEncoder().encode(c+'\n'));
                w.releaseLock();
            }catch(e){ addLog(`âŒ ${e.message}`,'error'); }
        }

        async function connectSerial(){
            try{
                port=await navigator.serial.requestPort();
                await port.open({baudRate:115200});
                document.getElementById('status').innerHTML='âœ… å·²é€£æ¥';
                document.getElementById('connectBtn').disabled=true;
                document.getElementById('disconnectBtn').disabled=false;
                addLog('âœ… é€£æ¥æˆåŠŸ','received');
                readLoop();
            }catch(e){ addLog(`âŒ é€£æ¥å¤±æ•—: ${e.message}`,'error'); }
        }

        async function disconnectSerial(){
            if(reader){ try{ await reader.cancel(); }catch(e){} reader=null; }
            if(port){ try{ await port.close(); }catch(e){} port=null; }
            document.getElementById('status').innerHTML='âš¡ æœªé€£æ¥';
            document.getElementById('connectBtn').disabled=false;
            document.getElementById('disconnectBtn').disabled=true;
            addLog('ğŸ”Œ å·²æ–·é–‹','received');
        }

        async function readLoop(){
            if(!port) return;
            try{
                reader=port.readable.getReader();
                const dec=new TextDecoder();
                let buf='';
                while(true){
                    const {value,done}=await reader.read();
                    if(done) break;
                    if(value){
                        buf+=dec.decode(value);
                        let lines=buf.split('\n');
                        buf=lines.pop();
                        for(let l of lines){
                            if(l.trim()){
                                addLog(`ğŸ“¥ ${l.trim()}`,'received');
                                if(l.includes('åŠ é€Ÿåº¦')||l.includes('é™€èºå„€')||l.includes('æº«åº¦')) addGyroLog(l.trim());
                                parseResponse(l);
                            }
                        }
                    }
                }
            }catch(e){ addLog(`âŒ è®€å–éŒ¯èª¤: ${e.message}`,'error'); }
            finally{ if(reader){ reader.releaseLock(); reader=null; } }
        }

        function parseResponse(l){
            const m=l.match(/(MV|HV) ID (\d+).*?(\d+)/);
            if(m){
                const g=m[1], id=parseInt(m[2]), ang=parseInt(m[3]);
                const inp=document.getElementById(`input_${g}_${id}`);
                if(inp&&Math.abs(parseInt(inp.value)-ang)>5){ inp.value=ang; currentAngles[`${g}_${id}`]=ang; }
            }
        }

        async function scanServos(){
            if(!port){ alert('è«‹å…ˆé€£æ¥'); return; }
            addLog('ğŸ” é–‹å§‹æƒæ...','sent');
            for(let i=1;i<=11;i++){ await sendCommand(`? MV ${i}`); await delay(50); }
            for(let i=1;i<=14;i++){ await sendCommand(`? HV ${i}`); await delay(50); }
            addLog('âœ… æƒæå®Œæˆ','received');
        }

        function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }

        window.onload=()=>{
            updatePanel('head');
            document.getElementById('selectHead').onclick=()=>updatePanel('head');
            document.getElementById('selectHand').onclick=()=>updatePanel('hand');
            document.getElementById('selectLeg').onclick=()=>updatePanel('leg');
            document.getElementById('connectBtn').onclick=connectSerial;
            document.getElementById('disconnectBtn').onclick=disconnectSerial;
            document.getElementById('scanBtn').onclick=scanServos;
            document.getElementById('testBtn').onclick=testConnection;
            document.getElementById('gyroBtn').onclick=queryGyro;
            document.getElementById('homeAllBtn').onclick=goHomeAll;
            document.getElementById('homeHeadBtn').onclick=goHomeHead;
            document.getElementById('homeHandBtn').onclick=goHomeHand;
            document.getElementById('homeLegBtn').onclick=goHomeLeg;
            document.getElementById('homeCurrentBtn').onclick=saveCurrentAsHome;
            document.getElementById('clearLogBtn').onclick=()=>document.getElementById('logContent').innerHTML='<div>[ç³»çµ±] LOGå·²æ¸…é™¤</div>';
            document.getElementById('clearGyroBtn').onclick=()=>document.getElementById('gyroContent').innerHTML='ç­‰å¾…é™€èºå„€æ•¸æ“š...';
            setupInputSelection();
            addLog('âœ… ç³»çµ±åˆå§‹åŒ–å®Œæˆ','received');
            addLog('âœ¨ é€Ÿåº¦ç¯„åœ:0-127','received');
        };
    </script>
</body>
</html>
