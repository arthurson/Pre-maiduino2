<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLEN2 â†’ Premaiduino å‹•ä½œè½‰æ›å™¨</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #6B73FF 0%, #000DFF 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            padding: 30px;
            gap: 30px;
        }
        
        .left-panel {
            flex: 1;
            min-width: 450px;
        }
        
        .right-panel {
            flex: 1.5;
            min-width: 600px;
        }
        
        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .speed-control {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .reverse-settings {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .test-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .batch-control {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .upload-area {
            border: 3px dashed #6B73FF;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .upload-area:hover {
            border-color: #000DFF;
            background: #f0f3ff;
        }
        
        .upload-area.dragover {
            background: #e3e7ff;
            border-color: #000DFF;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #6B73FF;
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-size: 18px;
            color: #666;
        }
        
        .upload-text strong {
            color: #6B73FF;
        }
        
        .file-info {
            background: #e8f4fd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        
        .file-info.show {
            display: block;
        }
        
        .info-row {
            display: flex;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #b8d9f5;
        }
        
        .info-label {
            font-weight: bold;
            width: 100px;
            color: #0366d6;
        }
        
        .info-value {
            flex: 1;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #6B73FF 0%, #000DFF 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(107, 115, 255, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        .btn-purple {
            background: #9c27b0;
            color: white;
        }
        
        .btn-purple:hover {
            background: #7b1fa2;
        }
        
        .speed-slider-container {
            background: #0f3460;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .speed-label {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            margin-bottom: 10px;
            color: white;
        }
        
        .speed-value {
            font-size: 36px;
            font-weight: bold;
            color: #00d4ff;
            text-align: center;
            margin: 10px 0;
        }
        
        input[type=range] {
            width: 100%;
            height: 10px;
            background: #1a1a2e;
            border-radius: 5px;
            outline: none;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 25px;
            height: 25px;
            background: #00d4ff;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .speed-presets {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .speed-preset-btn {
            padding: 8px 15px;
            background: #e9ecef;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .speed-preset-btn:hover {
            background: #6B73FF;
            color: white;
        }
        
        .servo-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .servo-table th {
            background: #6B73FF;
            color: white;
            padding: 8px;
            position: sticky;
            top: 0;
        }
        
        .servo-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .servo-table tr:hover {
            background: #f0f3ff;
        }
        
        .reverse-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .test-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .test-card .label {
            font-size: 12px;
            color: #6B73FF;
            font-weight: bold;
        }
        
        .test-card .value {
            font-size: 20px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .test-card .home {
            font-size: 11px;
            color: #888;
        }
        
        .test-card .range {
            font-size: 11px;
            color: #888;
        }
        
        .test-card.warning {
            border-left: 4px solid #ff4444;
        }
        
        .batch-preview {
            background: #1e1e3f;
            color: #a9dc76;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .tab-container {
            background: #f8f9fa;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .tab-header {
            display: flex;
            background: #e9ecef;
            border-bottom: 2px solid #dee2e6;
        }
        
        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: bold;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }
        
        .tab-btn.active {
            background: white;
            color: #6B73FF;
            border-bottom: 3px solid #6B73FF;
        }
        
        .tab-content {
            padding: 25px;
            background: white;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        .code-block {
            background: #1e1e3f;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
        }
        
        .serial-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .serial-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .serial-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
        }
        
        .serial-input:focus {
            border-color: #6B73FF;
            outline: none;
        }
        
        .serial-baud-rate {
            width: 120px;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .serial-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .serial-connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .serial-disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .serial-log {
            background: #1e1e3f;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 15px;
        }
        
        .log-controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            justify-content: flex-end;
        }
        
        .log-controls button {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .frame-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: white;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        
        .frame-btn {
            padding: 12px 5px;
            background: #e9ecef;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .frame-btn:hover {
            background: #6B73FF;
            color: white;
        }
        
        .frame-btn.active {
            background: #6B73FF;
            color: white;
            box-shadow: 0 0 10px #6B73FF;
        }
        
        .frame-commands {
            background: #1e1e3f;
            color: #a9dc76;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            margin: 15px 0;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .last-updated {
            font-size: 12px;
            color: #6c757d;
            text-align: right;
            margin-top: 5px;
        }
        
        .changed-indicator {
            color: #dc3545;
            font-weight: bold;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .formula-box {
            background: #f0f3ff;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .formula-box code {
            background: #1e1e3f;
            color: #a9dc76;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .servo-stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 13px;
        }
        
        .servo-stats-table th {
            background: #6B73FF;
            color: white;
            padding: 8px;
            text-align: left;
        }
        
        .servo-stats-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .servo-stats-table tr:hover {
            background: #f0f3ff;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– PLEN2 â†’ Premaiduino å‹•ä½œè½‰æ›å™¨</h1>
            <p>åªå‚³æœ‰éƒå˜…ä¼ºæœï½œæ¯”ä¾‹ 2.96ï½œè·¨Frameæ¯”å°ï½œé€Ÿåº¦å¯èª¿ 0.1-1.5xï½œBatch Send</p>
        </div>
        
        <div class="main-content">
            <div class="left-panel">
                <div class="upload-section">
                    <h2 style="margin-bottom: 20px; color: #495057;">ğŸ“¤ ä¸Šå‚³å‹•ä½œæª”</h2>
                    
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">ğŸ“‚</div>
                        <div class="upload-text">
                            <strong>é»æ“Šæ­¤è™•</strong> æˆ– <strong>æ‹–æ”¾æª”æ¡ˆ</strong><br>
                            æ”¯æ´æ ¼å¼: .json (PLEN2 å‹•ä½œæª”)
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept=".json" style="display: none;">
                    
                    <div class="file-info" id="fileInfo">
                        <h3 style="margin-bottom: 15px; color: #0366d6;">ğŸ“‹ æª”æ¡ˆè³‡è¨Š</h3>
                        <div class="info-row">
                            <span class="info-label">æª”æ¡ˆåç¨±</span>
                            <span class="info-value" id="fileName">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å‹•ä½œåç¨±</span>
                            <span class="info-value" id="actionName">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å½±æ ¼æ•¸é‡</span>
                            <span class="info-value" id="frameCount">-</span>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" id="convertBtn" disabled>ğŸ” åˆ†æå‹•ä½œ</button>
                        <button class="btn btn-secondary" id="clearBtn">ğŸ—‘ï¸ æ¸…é™¤</button>
                    </div>
                    
                    <div class="formula-box">
                        <strong>ğŸ“ å›ºå®šæ¯”ä¾‹ 2.96</strong><br>
                        <code>Premaiduino = HomePoint + (PLEN2 Ã— 2.96)</code><br>
                        <code>MV8å–ä»£MV10ï½œMV9å–ä»£MV11</code><br>
                        <code>JSON 0 = ä½  calibrate å˜… home point</code>
                    </div>
                </div>
                
                <div class="speed-control">
                    <h3 style="margin-bottom: 15px; color: #495057;">âš¡ é€Ÿåº¦èª¿æ•´ (0.1x - 1.5x)</h3>
                    
                    <div class="speed-slider-container">
                        <div class="speed-label">
                            <span>é€Ÿåº¦å€ç‡</span>
                            <span id="speedMultiplierDisplay" class="speed-value">0.25x</span>
                        </div>
                        <input type="range" id="speedMultiplier" min="0.1" max="1.5" step="0.05" value="0.25">
                        <div style="display: flex; justify-content: space-between; color: #888; margin-top: 5px;">
                            <span>0.1x (æœ€æ…¢)</span>
                            <span>0.25x (é è¨­)</span>
                            <span>0.5x</span>
                            <span>1.0x (æ­£å¸¸)</span>
                            <span>1.5x (æœ€å¿«)</span>
                        </div>
                    </div>
                    
                    <div class="speed-presets">
                        <button class="speed-preset-btn" id="speedMinBtn">ğŸ¢ 0.1x</button>
                        <button class="speed-preset-btn" id="speedQuarterBtn">ğŸ¢ 0.25x (é è¨­)</button>
                        <button class="speed-preset-btn" id="speedHalfBtn">ğŸ¢ 0.5x</button>
                        <button class="speed-preset-btn" id="speedNormalBtn">âš¡ 1.0x (æ­£å¸¸)</button>
                        <button class="speed-preset-btn" id="speedMaxBtn">ğŸš€ 1.5x</button>
                    </div>
                    <p style="font-size: 12px; color: #00cc66; margin-top: 5px;">âœ… è¼‰å…¥JSONå¾Œè‡ªå‹•å¥—ç”¨0.25x</p>
                </div>
                
                <div class="reverse-settings">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #495057;">ğŸ”„ åè½‰è¨­å®š</h3>
                        <button class="btn btn-info" id="renewBtn" disabled>ğŸ”„ æ›´æ–°è½‰æ›</button>
                    </div>
                    <p style="font-size: 13px; color: #6c757d; margin-bottom: 15px;">
                        æ‰“å‹¾è¡¨ç¤ºè©²ä¼ºæœéœ€è¦åè½‰ï¼ŒæŒ‰ <strong>æ›´æ–°è½‰æ›</strong> é‡æ–°è¨ˆç®—
                        <span id="changedIndicator" class="changed-indicator" style="display: none;">âš¡ å·²æ›´æ”¹</span>
                    </p>
                    <div style="max-height: 350px; overflow-y: auto;">
                        <table class="servo-table">
                            <thead>
                                <tr>
                                    <th>ç¾¤çµ„</th>
                                    <th>ID</th>
                                    <th>ä¸­æ–‡åç¨±</th>
                                    <th>Home</th>
                                    <th>åè½‰</th>
                                </tr>
                            </thead>
                            <tbody id="reverseTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="test-section">
                    <h3 style="margin-bottom: 15px; color: #495057;">ğŸ“Š å³æ™‚è¨ˆç®—æ¸¬è©¦</h3>
                    <div id="testGrid" class="test-grid">
                        <!-- ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="batch-control">
                    <h3 style="margin-bottom: 15px; color: #495057;">ğŸ“¦ Batch Send</h3>
                    <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                        ä¸€æ¬¡éå‚³é€æ‰€æœ‰ Frame æŒ‡ä»¤ï¼ˆé€è¡Œç™¼é€ï¼Œç­‰ Premaiduino è‡ªå·± bufferï¼‰
                    </p>
                    
                    <div class="batch-preview" id="batchPreview">
                        ä¸Šå‚³ JSON å¾Œæœƒé¡¯ç¤º Batch æŒ‡ä»¤
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-purple" id="sendBatchBtn" disabled>ğŸ“¤ ç™¼é€ Batch</button>
                        <button class="btn btn-secondary" id="copyBatchBtn" disabled>ğŸ“‹ è¤‡è£½ Batch</button>
                    </div>
                    <p style="font-size: 13px; color: #666; margin-top: 10px;">
                        â±ï¸ ç¸½æ™‚é–“: <span id="batchTotalTime">0</span> ms
                    </p>
                </div>
                
                <div class="tab-container">
                    <div class="tab-header">
                        <button class="tab-btn active" data-tab="frames">ğŸ¬ å½±æ ¼åˆ—è¡¨</button>
                        <button class="tab-btn" data-tab="commands">ğŸ“Ÿ æ‰€æœ‰æŒ‡ä»¤</button>
                        <button class="tab-btn" data-tab="stats">ğŸ“Š çµ±è¨ˆ</button>
                    </div>
                    
                    <div class="tab-content">
                        <div class="tab-pane active" id="frames-pane">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: #495057;">ğŸ¬ å½±æ ¼åˆ—è¡¨</h3>
                                <div>
                                    <button class="btn btn-success" id="playAllBtn" disabled>â–¶ï¸ æ’­æ”¾å…¨éƒ¨</button>
                                    <button class="btn btn-warning" id="homeBtn" disabled>ğŸ  å…¨é«”å›å®¶</button>
                                </div>
                            </div>
                            
                            <div id="frameGrid" class="frame-grid">
                                <p class="warning-message">ä¸Šå‚³ JSON å¾Œæœƒé¡¯ç¤ºå½±æ ¼</p>
                            </div>
                            
                            <div id="frameDetail" style="margin-top: 20px; display: none;">
                                <h4 id="frameTitle">å½±æ ¼ 0</h4>
                                <div class="frame-commands" id="frameCommand"></div>
                                <div style="display: flex; gap: 10px; margin-top: 15px;">
                                    <button class="btn btn-primary" id="sendFrameBtn" disabled>ğŸ“¤ ç™¼é€å‘¢å€‹å½±æ ¼</button>
                                    <button class="btn btn-secondary" id="copyFrameBtn" disabled>ğŸ“‹ è¤‡è£½æŒ‡ä»¤</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane" id="commands-pane">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: #495057;">ğŸ“Ÿ æ‰€æœ‰FrameæŒ‡ä»¤</h3>
                                <button class="copy-btn" id="copyAllBtn">ğŸ“‹ è¤‡è£½å…¨éƒ¨</button>
                            </div>
                            <pre class="code-block" id="allCommandsOutput">// ä¸Šå‚³ JSON å¾Œæœƒé¡¯ç¤ºæ‰€æœ‰æŒ‡ä»¤</pre>
                        </div>
                        
                        <div class="tab-pane" id="stats-pane">
                            <h3 style="color: #495057; margin-bottom: 15px;">ğŸ“Š å‹•ä½œçµ±è¨ˆ</h3>
                            <div id="statsOutput"></div>
                        </div>
                    </div>
                </div>
                
                <div class="serial-section">
                    <h3 style="margin-bottom: 15px; color: #495057;">ğŸ”Œ ä¸²å£æ§åˆ¶</h3>
                    
                    <div class="serial-input-group">
                        <select id="baudRate" class="serial-baud-rate">
                            <option value="9600">9600</option>
                            <option value="19200">19200</option>
                            <option value="38400">38400</option>
                            <option value="57600">57600</option>
                            <option value="115200" selected>115200</option>
                            <option value="250000">250000</option>
                            <option value="500000">500000</option>
                            <option value="1000000">1000000</option>
                        </select>
                        <button class="btn btn-success" id="connectSerial">ğŸ”Œ é€£æ¥</button>
                        <button class="btn btn-danger" id="disconnectSerial" disabled>âŒ æ–·é–‹</button>
                    </div>
                    
                    <div id="serialStatus" class="serial-status serial-disconnected">
                        ğŸ”´ æœªé€£æ¥
                    </div>
                    
                    <div class="log-controls">
                        <button class="btn btn-secondary" id="saveLogBtn">ğŸ’¾ å„²å­˜æ—¥èªŒ</button>
                        <button class="btn btn-secondary" id="clearLogBtn">ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ</button>
                    </div>
                    
                    <div class="serial-log" id="serialLog">
                        ğŸ“‹ ä¸²å£æ—¥èªŒ...
                    </div>
                    
                    <div class="serial-input-group" style="margin-top: 15px;">
                        <input type="text" id="customCommand" class="serial-input" placeholder="è¼¸å…¥è‡ªè¨‚æŒ‡ä»¤" disabled>
                        <button class="btn btn-primary" id="sendCustomBtn" disabled>ğŸ“¤ ç™¼é€</button>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>âœ… åªå‚³æœ‰éƒå˜…ä¼ºæœï½œJSON 0 = ä½  calibrate å˜… home pointï½œæ¯”ä¾‹ 2.96ï½œé€Ÿåº¦ 0.1-1.5xï½œé è¨­ 0.25xï½œä¸€å…¥JSONè‡ªå‹•å¥—ç”¨</p>
        </footer>
    </div>
    
    <script>
        // ===== Premaiduino 25 å€‹ä¼ºæœ Home Point (ä½  calibrate å˜…æ•¸) =====
        const ALL_HOME_POINTS = {
            // HVç¾¤ (14å€‹)
            'HV1': 10200, 'HV2': 4700, 'HV3': 7780, 'HV4': 7500,
            'HV5': 7400, 'HV6': 7600, 'HV7': 7500, 'HV8': 7500,
            'HV9': 7500, 'HV10': 7500, 'HV11': 7500, 'HV12': 7550,
            'HV13': 7825, 'HV14': 7450,
            
            // MVç¾¤ (11å€‹)
            'MV1': 7500, 'MV2': 7500, 'MV3': 7500, 'MV4': 9800,
            'MV5': 5200, 'MV6': 7500, 'MV7': 7500, 'MV8': 7500,
            'MV9': 7500, 'MV10': 5000, 'MV11': 10000
        };
        
        // ===== ç¯„åœé™åˆ¶ =====
        const RANGES = {
            'HV1': {min:4300, max:11500}, 'HV2': {min:3500, max:10700},
            'HV3': {min:6530, max:9030}, 'HV4': {min:6250, max:8750},
            'HV5': {min:6700, max:8300}, 'HV6': {min:6700, max:8300},
            'HV7': {min:4700, max:10200}, 'HV8': {min:4700, max:10200},
            'HV9': {min:3950, max:7600}, 'HV10': {min:7400, max:11050},
            'HV11': {min:5700, max:8300}, 'HV12': {min:6750, max:9350},
            'HV13': {min:6800, max:9150}, 'HV14': {min:6200, max:8450},
            'MV4': {min:7450, max:10350}, 'MV5': {min:4550, max:7550},
            'MV8': {min:7100, max:11000}, 'MV9': {min:4000, max:7900}
        };
        
        // ===== åè½‰è¨­å®š (æœ€æ–°ç‰ˆ) =====
        let reverseSettings = {
            'HV5': true, 'HV6': true,     // é«‹éƒ¨å´æŠ¬ åè½‰
            'HV11': false, 'HV12': false,  // è…³è¸å‰å¾Œ æ­£å¸¸
            'HV13': false, 'HV14': false,  // è…³è¸å´å‚¾ æ­£å¸¸
            'HV3': false, 'HV4': false,    // é«‹éƒ¨æ—‹è½‰ æ­£å¸¸
            'HV7': false, 'HV8': false,    // å¤§è…¿å‰å¾Œ å¾…æ¸¬è©¦ (é è¨­æ­£å¸¸)
            'HV9': false, 'HV10': false     // è†è“‹ å¾…æ¸¬è©¦ (é è¨­æ­£å¸¸)
        };
        
        // ===== PLEN2 åç¨±å°æ‡‰ (MV8å–ä»£MV10, MV9å–ä»£MV11) =====
        const NAME_MAPPING = {
            'left_shoulder_pitch': 'HV2',
            'right_shoulder_pitch': 'HV1',
            'left_thigh_yaw': 'HV4',
            'right_thigh_yaw': 'HV3',
            'left_shoulder_roll': 'MV5',
            'right_shoulder_roll': 'MV4',
            'left_elbow_roll': 'MV9',
            'right_elbow_roll': 'MV8',
            'left_thigh_roll': 'HV6',
            'right_thigh_roll': 'HV5',
            'left_thigh_pitch': 'HV8',
            'right_thigh_pitch': 'HV7',
            'left_knee_pitch': 'HV10',
            'right_knee_pitch': 'HV9',
            'left_foot_pitch': 'HV12',
            'right_foot_pitch': 'HV11',
            'left_foot_roll': 'HV14',
            'right_foot_roll': 'HV13'
        };
        
        // ===== å›ºå®šæ¯”ä¾‹ =====
        const FIXED_RATIO = 2.96;
        
        // ===== å…¨åŸŸè®Šæ•¸ =====
        let currentJsonData = null;
        let processedFrames = [];
        let originalFrames = [];
        let activeServosSet = new Set();
        let serialPort = null;
        let reader = null;
        let writer = null;
        let isPlaying = false;
        let currentSpeedMultiplier = 0.25;
        let servoMoveCount = {};
        let changesMade = false;
        
        // ===== DOM å…ƒç´  =====
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const actionName = document.getElementById('actionName');
        const frameCount = document.getElementById('frameCount');
        const convertBtn = document.getElementById('convertBtn');
        const clearBtn = document.getElementById('clearBtn');
        const renewBtn = document.getElementById('renewBtn');
        const reverseTableBody = document.getElementById('reverseTableBody');
        const lastUpdated = document.getElementById('lastUpdated');
        const changedIndicator = document.getElementById('changedIndicator');
        const testGrid = document.getElementById('testGrid');
        
        // é€Ÿåº¦æ§åˆ¶
        const speedMultiplier = document.getElementById('speedMultiplier');
        const speedMultiplierDisplay = document.getElementById('speedMultiplierDisplay');
        const speedMinBtn = document.getElementById('speedMinBtn');
        const speedQuarterBtn = document.getElementById('speedQuarterBtn');
        const speedHalfBtn = document.getElementById('speedHalfBtn');
        const speedNormalBtn = document.getElementById('speedNormalBtn');
        const speedMaxBtn = document.getElementById('speedMaxBtn');
        
        // Batch ç›¸é—œ
        const batchPreview = document.getElementById('batchPreview');
        const sendBatchBtn = document.getElementById('sendBatchBtn');
        const copyBatchBtn = document.getElementById('copyBatchBtn');
        const batchTotalTime = document.getElementById('batchTotalTime');
        
        // å½±æ ¼ç›¸é—œ
        const playAllBtn = document.getElementById('playAllBtn');
        const homeBtn = document.getElementById('homeBtn');
        const frameGrid = document.getElementById('frameGrid');
        const frameDetail = document.getElementById('frameDetail');
        const frameTitle = document.getElementById('frameTitle');
        const frameCommand = document.getElementById('frameCommand');
        const sendFrameBtn = document.getElementById('sendFrameBtn');
        const copyFrameBtn = document.getElementById('copyFrameBtn');
        
        // æŒ‡ä»¤ç›¸é—œ
        const allCommandsOutput = document.getElementById('allCommandsOutput');
        const copyAllBtn = document.getElementById('copyAllBtn');
        const statsOutput = document.getElementById('statsOutput');
        
        // ä¸²å£ç›¸é—œ
        const connectSerial = document.getElementById('connectSerial');
        const disconnectSerial = document.getElementById('disconnectSerial');
        const serialStatus = document.getElementById('serialStatus');
        const customCommand = document.getElementById('customCommand');
        const sendCustomBtn = document.getElementById('sendCustomBtn');
        const serialLog = document.getElementById('serialLog');
        const saveLogBtn = document.getElementById('saveLogBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const baudRate = document.getElementById('baudRate');
        
        // ===== åˆå§‹åŒ– =====
        function init() {
            renderReverseTable();
            renderTestGrid();
            setupEventListeners();
            if (serialLog) {
                addSerialLog('âœ… å‹•ä½œè½‰æ›å™¨å·²å•Ÿå‹•');
                addSerialLog('ğŸ“Š æ¯”ä¾‹ 2.96ï½œåªå‚³æœ‰éƒå˜…ä¼ºæœ');
                addSerialLog('ğŸ“Œ JSON 0 = ä½  calibrate å˜… home point');
                addSerialLog('âš¡ é€Ÿåº¦ 0.1-1.5xï½œé è¨­ 0.25x - ä¸€å…¥JSONè‡ªå‹•å¥—ç”¨');
            }
        }
        
        // ===== è¨­å®šäº‹ä»¶ç›£è½ =====
        function setupEventListeners() {
            if (uploadArea) {
                uploadArea.addEventListener('click', function() {
                    fileInput.click();
                });
                
                uploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', function() {
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    if (e.dataTransfer.files.length > 0) {
                        handleFile(e.dataTransfer.files[0]);
                    }
                });
            }
            
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        handleFile(e.target.files[0]);
                    }
                });
            }
            
            if (clearBtn) {
                clearBtn.addEventListener('click', clearAll);
            }
            
            if (convertBtn) {
                convertBtn.addEventListener('click', function() {
                    if (currentJsonData) processMotion(currentJsonData);
                });
            }
            
            if (renewBtn) {
                renewBtn.addEventListener('click', function() {
                    if (currentJsonData) {
                        processMotion(currentJsonData);
                        changesMade = false;
                        changedIndicator.style.display = 'none';
                        renewBtn.disabled = true;
                    }
                });
            }
            
            if (speedMultiplier) {
                speedMultiplier.addEventListener('input', function() {
                    const val = parseFloat(speedMultiplier.value);
                    speedMultiplierDisplay.textContent = val.toFixed(2) + 'x';
                    currentSpeedMultiplier = val;
                    if (currentJsonData) applySpeedMultiplier();
                });
            }
            
            if (speedMinBtn) {
                speedMinBtn.addEventListener('click', function() {
                    speedMultiplier.value = 0.1;
                    speedMultiplierDisplay.textContent = '0.10x';
                    currentSpeedMultiplier = 0.1;
                    if (currentJsonData) applySpeedMultiplier();
                });
            }
            
            if (speedQuarterBtn) {
                speedQuarterBtn.addEventListener('click', function() {
                    speedMultiplier.value = 0.25;
                    speedMultiplierDisplay.textContent = '0.25x';
                    currentSpeedMultiplier = 0.25;
                    if (currentJsonData) applySpeedMultiplier();
                });
            }
            
            if (speedHalfBtn) {
                speedHalfBtn.addEventListener('click', function() {
                    speedMultiplier.value = 0.5;
                    speedMultiplierDisplay.textContent = '0.50x';
                    currentSpeedMultiplier = 0.5;
                    if (currentJsonData) applySpeedMultiplier();
                });
            }
            
            if (speedNormalBtn) {
                speedNormalBtn.addEventListener('click', function() {
                    speedMultiplier.value = 1.0;
                    speedMultiplierDisplay.textContent = '1.00x';
                    currentSpeedMultiplier = 1.0;
                    if (currentJsonData) applySpeedMultiplier();
                });
            }
            
            if (speedMaxBtn) {
                speedMaxBtn.addEventListener('click', function() {
                    speedMultiplier.value = 1.5;
                    speedMultiplierDisplay.textContent = '1.50x';
                    currentSpeedMultiplier = 1.5;
                    if (currentJsonData) applySpeedMultiplier();
                });
            }
            
            if (sendBatchBtn) {
                sendBatchBtn.addEventListener('click', sendBatch);
            }
            
            if (copyBatchBtn) {
                copyBatchBtn.addEventListener('click', copyBatch);
            }
            
            if (playAllBtn) {
                playAllBtn.addEventListener('click', playAll);
            }
            
            if (homeBtn) {
                homeBtn.addEventListener('click', sendHome);
            }
            
            if (copyAllBtn) {
                copyAllBtn.addEventListener('click', copyAllCommands);
            }
            
            if (sendFrameBtn) {
                sendFrameBtn.addEventListener('click', function() {
                    const activeBtn = document.querySelector('.frame-btn.active');
                    if (activeBtn) sendFrame(parseInt(activeBtn.dataset.index));
                });
            }
            
            if (copyFrameBtn) {
                copyFrameBtn.addEventListener('click', function() {
                    const activeBtn = document.querySelector('.frame-btn.active');
                    if (activeBtn && processedFrames[activeBtn.dataset.index]) {
                        copyToClipboard(processedFrames[activeBtn.dataset.index].command);
                    }
                });
            }
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                    btn.classList.add('active');
                    const pane = document.getElementById(btn.getAttribute('data-tab') + '-pane');
                    if (pane) pane.classList.add('active');
                });
            });
            
            if (connectSerial) {
                connectSerial.addEventListener('click', connectSerialPort);
            }
            
            if (disconnectSerial) {
                disconnectSerial.addEventListener('click', disconnectSerialPort);
            }
            
            if (sendCustomBtn) {
                sendCustomBtn.addEventListener('click', sendCustomCommand);
            }
            
            if (customCommand) {
                customCommand.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') sendCustomCommand();
                });
            }
            
            if (saveLogBtn) {
                saveLogBtn.addEventListener('click', saveLog);
            }
            
            if (clearLogBtn) {
                clearLogBtn.addEventListener('click', function() {
                    if (serialLog) serialLog.innerHTML = 'ğŸ“‹ ä¸²å£æ—¥èªŒ...';
                });
            }
        }
        
        // ===== åˆå§‹åŒ–åè½‰è¡¨æ ¼ =====
        function renderReverseTable() {
            if (!reverseTableBody) return;
            
            const allServos = [];
            
            // HV 1-14
            for (let i = 1; i <= 14; i++) {
                const id = `HV${i}`;
                allServos.push({
                    group: 'HV',
                    id: i,
                    name: getServoName('HV', i),
                    home: ALL_HOME_POINTS[id],
                    reverse: reverseSettings[id] || false
                });
            }
            
            // MV 1-11
            for (let i = 1; i <= 11; i++) {
                const id = `MV${i}`;
                allServos.push({
                    group: 'MV',
                    id: i,
                    name: getServoName('MV', i),
                    home: ALL_HOME_POINTS[id],
                    reverse: reverseSettings[id] || false
                });
            }
            
            let html = '';
            allServos.forEach(servo => {
                html += `
                    <tr>
                        <td>${servo.group}</td>
                        <td>${servo.id}</td>
                        <td>${servo.name}</td>
                        <td>${servo.home}</td>
                        <td>
                            <input type="checkbox" class="reverse-checkbox" 
                                   data-id="${servo.group}${servo.id}"
                                   ${servo.reverse ? 'checked' : ''}>
                        </td>
                    </tr>
                `;
            });
            
            reverseTableBody.innerHTML = html;
            
            document.querySelectorAll('.reverse-checkbox').forEach(cb => {
                cb.addEventListener('change', function(e) {
                    const servoId = e.target.dataset.id;
                    reverseSettings[servoId] = e.target.checked;
                    changesMade = true;
                    if (changedIndicator) changedIndicator.style.display = 'inline';
                    if (renewBtn) renewBtn.disabled = false;
                    
                    // æ›´æ–°æ¸¬è©¦
                    updateTestCalculations();
                });
            });
        }
        
        // ===== å–å¾—ä¼ºæœä¸­æ–‡åç¨± =====
        function getServoName(group, id) {
            const names = {
                'HV1': 'è‚©ãƒ”ãƒƒãƒR', 'HV2': 'è‚©ãƒ”ãƒƒãƒL', 'HV3': 'ãƒ’ãƒƒãƒ—ãƒ¨ãƒ¼R',
                'HV4': 'ãƒ’ãƒƒãƒ—ãƒ¨ãƒ¼L', 'HV5': 'ãƒ’ãƒƒãƒ—ãƒ­ãƒ¼ãƒ«R', 'HV6': 'ãƒ’ãƒƒãƒ—ãƒ­ãƒ¼ãƒ«L',
                'HV7': 'è…¿ãƒ”ãƒƒãƒR', 'HV8': 'è…¿ãƒ”ãƒƒãƒL', 'HV9': 'è†ãƒ”ãƒƒãƒR',
                'HV10': 'è†ãƒ”ãƒƒãƒL', 'HV11': 'è¶³é¦–ãƒ”ãƒƒãƒR', 'HV12': 'è¶³é¦–ãƒ”ãƒƒãƒL',
                'HV13': 'è¶³é¦–ãƒ­ãƒ¼ãƒ«R', 'HV14': 'è¶³é¦–ãƒ­ãƒ¼ãƒ«L',
                'MV1': 'é ­ãƒ”ãƒƒãƒ', 'MV2': 'é ­ãƒ¨ãƒ¼', 'MV3': 'é ­èŒ',
                'MV4': 'è‚©ãƒ­ãƒ¼ãƒ«R', 'MV5': 'è‚©ãƒ­ãƒ¼ãƒ«L', 'MV6': 'ä¸Šè…•ãƒ¨ãƒ¼R',
                'MV7': 'ä¸Šè…•ãƒ¨ãƒ¼L', 'MV8': 'è‚˜ãƒ”ãƒƒãƒR', 'MV9': 'è‚˜ãƒ”ãƒƒãƒL',
                'MV10': 'æ‰‹é¦–ãƒ¨ãƒ¼R', 'MV11': 'æ‰‹é¦–ãƒ¨ãƒ¼L'
            };
            return names[`${group}${id}`] || '-';
        }
        
        // ===== æ¸²æŸ“æ¸¬è©¦æ ¼ä»” =====
        function renderTestGrid() {
            if (!testGrid) return;
            
            const testServos = [
                { id: 'HV1', home: 10200, plen: -621, label: 'HV1 èˆ‰é«˜' },
                { id: 'HV1', home: 10200, plen: -388, label: 'HV1 æ”¾ä½' },
                { id: 'HV2', home: 4700, plen: 621, label: 'HV2 èˆ‰é«˜' },
                { id: 'HV2', home: 4700, plen: 388, label: 'HV2 æ”¾ä½' },
                { id: 'MV4', home: 9800, plen: -16, label: 'MV4' },
                { id: 'MV5', home: 5200, plen: 16, label: 'MV5' },
                { id: 'MV8', home: 7500, plen: 249, label: 'MV8' },
                { id: 'MV9', home: 7500, plen: -249, label: 'MV9' },
                { id: 'HV5', home: 7400, plen: 100, label: 'HV5 æ¸¬è©¦' },
                { id: 'HV6', home: 7600, plen: 84, label: 'HV6 æ¸¬è©¦' }
            ];
            
            let html = '';
            testServos.forEach(servo => {
                const value = convertAngle(servo.plen, servo.id);
                const range = RANGES[servo.id] || {min:3500, max:11500};
                const outOfRange = value < range.min || value > range.max;
                const reverseStatus = reverseSettings[servo.id] ? ' (åè½‰)' : '';
                
                html += `
                    <div class="test-card ${outOfRange ? 'warning' : ''}" id="test-${servo.id}-${servo.plen}">
                        <div class="label">${servo.label}${reverseStatus}</div>
                        <div class="value">${value}</div>
                        <div class="home">Home: ${servo.home}</div>
                        <div class="range">ç¯„åœ: ${range.min}-${range.max}</div>
                    </div>
                `;
            });
            
            testGrid.innerHTML = html;
        }
        
        // ===== æ›´æ–°æ¸¬è©¦è¨ˆç®— =====
        function updateTestCalculations() {
            const testServos = [
                { id: 'HV1', home: 10200, plen: -621, label: 'HV1 èˆ‰é«˜', el: 'test-HV1--621' },
                { id: 'HV1', home: 10200, plen: -388, label: 'HV1 æ”¾ä½', el: 'test-HV1--388' },
                { id: 'HV2', home: 4700, plen: 621, label: 'HV2 èˆ‰é«˜', el: 'test-HV2-621' },
                { id: 'HV2', home: 4700, plen: 388, label: 'HV2 æ”¾ä½', el: 'test-HV2-388' },
                { id: 'MV4', home: 9800, plen: -16, label: 'MV4', el: 'test-MV4--16' },
                { id: 'MV5', home: 5200, plen: 16, label: 'MV5', el: 'test-MV5-16' },
                { id: 'MV8', home: 7500, plen: 249, label: 'MV8', el: 'test-MV8-249' },
                { id: 'MV9', home: 7500, plen: -249, label: 'MV9', el: 'test-MV9--249' },
                { id: 'HV5', home: 7400, plen: 100, label: 'HV5 æ¸¬è©¦', el: 'test-HV5-100' },
                { id: 'HV6', home: 7600, plen: 84, label: 'HV6 æ¸¬è©¦', el: 'test-HV6-84' }
            ];
            
            testServos.forEach(servo => {
                const value = convertAngle(servo.plen, servo.id);
                const range = RANGES[servo.id] || {min:3500, max:11500};
                const outOfRange = value < range.min || value > range.max;
                
                const el = document.getElementById(servo.el);
                if (el) {
                    const valueDiv = el.querySelector('.value');
                    if (valueDiv) valueDiv.textContent = value;
                    
                    if (outOfRange) {
                        el.classList.add('warning');
                    } else {
                        el.classList.remove('warning');
                    }
                    
                    const labelDiv = el.querySelector('.label');
                    if (labelDiv) {
                        const reverseStatus = reverseSettings[servo.id] ? ' (åè½‰)' : '';
                        labelDiv.innerHTML = servo.label + reverseStatus;
                    }
                }
            });
        }
        
        // ===== è½‰æ›è§’åº¦ =====
        function convertAngle(plenValue, servoId) {
            const home = ALL_HOME_POINTS[servoId] || 7500;
            let value = Math.round(home + (plenValue * FIXED_RATIO));
            
            if (reverseSettings[servoId]) {
                const range = RANGES[servoId];
                if (range) {
                    value = range.min + range.max - value;
                }
            }
            
            return value;
        }
        
        // ===== è™•ç†æª”æ¡ˆ =====
        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.json')) {
                alert('è«‹ä¸Šå‚³ JSON æ ¼å¼çš„æª”æ¡ˆï¼');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    currentJsonData = jsonData;
                    
                    if (fileName) fileName.textContent = file.name;
                    if (actionName) actionName.textContent = jsonData.name || 'æœªçŸ¥';
                    if (frameCount) frameCount.textContent = jsonData.frames ? jsonData.frames.length : 0;
                    if (fileInfo) fileInfo.classList.add('show');
                    
                    if (convertBtn) convertBtn.disabled = false;
                    processMotion(jsonData);
                    
                } catch (error) {
                    alert('JSON è§£æéŒ¯èª¤ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        // ===== æ¸…é™¤æ‰€æœ‰ =====
        function clearAll() {
            currentJsonData = null;
            processedFrames = [];
            originalFrames = [];
            activeServosSet.clear();
            servoMoveCount = {};
            
            if (fileInfo) fileInfo.classList.remove('show');
            if (fileName) fileName.textContent = '-';
            if (actionName) actionName.textContent = '-';
            if (frameCount) frameCount.textContent = '-';
            
            if (convertBtn) convertBtn.disabled = true;
            if (renewBtn) renewBtn.disabled = true;
            if (playAllBtn) playAllBtn.disabled = true;
            if (homeBtn) homeBtn.disabled = true;
            if (sendBatchBtn) sendBatchBtn.disabled = true;
            if (copyBatchBtn) copyBatchBtn.disabled = true;
            
            if (frameGrid) frameGrid.innerHTML = '<p class="warning-message">ä¸Šå‚³ JSON å¾Œæœƒé¡¯ç¤ºå½±æ ¼</p>';
            if (frameDetail) frameDetail.style.display = 'none';
            if (allCommandsOutput) allCommandsOutput.textContent = '// ä¸Šå‚³ JSON å¾Œæœƒé¡¯ç¤ºæ‰€æœ‰æŒ‡ä»¤';
            if (batchPreview) batchPreview.innerHTML = 'ä¸Šå‚³ JSON å¾Œæœƒé¡¯ç¤º Batch æŒ‡ä»¤';
            if (batchTotalTime) batchTotalTime.textContent = '0';
            if (statsOutput) statsOutput.innerHTML = '';
            if (lastUpdated) lastUpdated.innerHTML = '';
            
            changesMade = false;
            if (changedIndicator) changedIndicator.style.display = 'none';
            
            if (speedMultiplier) {
                speedMultiplier.value = 0.25;
                speedMultiplierDisplay.textContent = '0.25x';
                currentSpeedMultiplier = 0.25;
            }
            if (fileInput) fileInput.value = '';
        }
        
        // ===== ç”Ÿæˆå…¨é«”å›å®¶æŒ‡ä»¤ =====
        function generateHomeCommand() {
            let cmd = 'S MULTI 64 25';
            for (let i = 1; i <= 14; i++) cmd += ` HV${i} ${ALL_HOME_POINTS[`HV${i}`]}`;
            for (let i = 1; i <= 11; i++) cmd += ` MV${i} ${ALL_HOME_POINTS[`MV${i}`]}`;
            return cmd;
        }
        
        // ===== å¥—ç”¨é€Ÿåº¦å€ç‡ =====
        function applySpeedMultiplier() {
            if (originalFrames.length === 0) return;
            
            for (let i = 0; i < processedFrames.length; i++) {
                const frame = processedFrames[i];
                const originalFrame = originalFrames.find(f => f.index === frame.index);
                if (originalFrame) {
                    const newSpeed = Math.round(originalFrame.originalSpeed * currentSpeedMultiplier);
                    frame.speed = Math.max(20, Math.min(127, newSpeed));
                    
                    const cmdParts = frame.command.split(' ');
                    if (cmdParts.length >= 3) {
                        cmdParts[2] = frame.speed.toString();
                        frame.command = cmdParts.join(' ');
                    }
                }
            }
            
            renderAllCommands();
            updateBatchPreview();
            
            const activeBtn = document.querySelector('.frame-btn.active');
            if (activeBtn) showFrame(parseInt(activeBtn.dataset.index));
            
            addSerialLog(`âš¡ é€Ÿåº¦å€ç‡: ${currentSpeedMultiplier.toFixed(2)}x`);
        }
        
        // ===== è™•ç†å‹•ä½œ =====
        function processMotion(json) {
            if (!json.frames || !Array.isArray(json.frames)) {
                alert('JSON æ ¼å¼éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° frames é™£åˆ—');
                return;
            }
            
            processedFrames = [];
            originalFrames = [];
            activeServosSet.clear();
            servoMoveCount = {};
            
            // æ”¶é›†æœ‰éƒå˜… servo (value â‰  0)
            json.frames.forEach(frame => {
                if (frame.outputs) {
                    frame.outputs.forEach(output => {
                        if (NAME_MAPPING[output.device] && output.value !== 0) {
                            activeServosSet.add(NAME_MAPPING[output.device]);
                        }
                    });
                }
            });
            
            // è½‰æ›æ¯å€‹å½±æ ¼ï¼Œåªè¨˜éŒ„æœ‰éƒå˜… servo
            json.frames.forEach((frame, index) => {
                const time = frame.transition_time_ms || 500;
                let speed = Math.round(mapValue(time, 100, 2000, 127, 20));
                speed = Math.max(20, Math.min(127, speed));
                
                let frameValues = {};
                if (frame.outputs) {
                    frame.outputs.forEach(output => {
                        if (NAME_MAPPING[output.device] && output.value !== 0) {
                            const servoId = NAME_MAPPING[output.device];
                            frameValues[servoId] = convertAngle(output.value, servoId);
                            
                            if (!servoMoveCount[servoId]) servoMoveCount[servoId] = 0;
                        }
                    });
                }
                
                originalFrames.push({
                    index, time, originalSpeed: speed, speed, values: frameValues
                });
            });
            
            // è¨ˆç®—ç§»å‹•æ¬¡æ•¸
            let lastValues = {};
            for (let i = 0; i < originalFrames.length; i++) {
                const currentValues = originalFrames[i].values;
                Object.keys(currentValues).forEach(servoId => {
                    if (i === 0 || currentValues[servoId] !== lastValues[servoId]) {
                        servoMoveCount[servoId]++;
                    }
                });
                lastValues = {...currentValues};
            }
            
            // ç”ŸæˆæŒ‡ä»¤ï¼ˆåªå‚³æœ‰éƒå˜…ï¼‰
            lastValues = {};
            for (let i = 0; i < originalFrames.length; i++) {
                const frame = originalFrames[i];
                const currentValues = frame.values;
                
                let servoData = [];
                Object.keys(currentValues).forEach(servoId => {
                    if (i === 0 || currentValues[servoId] !== lastValues[servoId]) {
                        servoData.push(`${servoId} ${currentValues[servoId]}`);
                    }
                });
                
                if (servoData.length > 0) {
                    processedFrames.push({
                        index: frame.index,
                        time: frame.time,
                        speed: frame.speed,
                        command: `S MULTI ${frame.speed} ${servoData.length} ${servoData.join(' ')}`,
                        servoCount: servoData.length
                    });
                }
                
                lastValues = {...currentValues};
            }
            
            // æ›´æ–°UI
            renderFrameButtons();
            renderAllCommands();
            updateBatchPreview();
            renderStats();
            
            if (playAllBtn) playAllBtn.disabled = false;
            if (homeBtn) homeBtn.disabled = false;
            if (sendBatchBtn) sendBatchBtn.disabled = false;
            if (copyBatchBtn) copyBatchBtn.disabled = false;
            if (renewBtn) renewBtn.disabled = true;
            if (lastUpdated) lastUpdated.innerHTML = 'âœ… å·²åˆ†æï¼š' + new Date().toLocaleTimeString();
            
            changesMade = false;
            if (changedIndicator) changedIndicator.style.display = 'none';
            
            addSerialLog(`ğŸ“‚ å·²è¼‰å…¥: ${json.name || 'æœªçŸ¥'} (${processedFrames.length}å€‹å½±æ ¼)`);
            addSerialLog(`ğŸ” æœ‰ ${activeServosSet.size} å€‹ä¼ºæœæœƒéƒ`);
            
            // è‡ªå‹•å¥—ç”¨ç•¶å‰é€Ÿåº¦å€ç‡ (0.25x)
            applySpeedMultiplier();
        }
        
        // ===== é¡¯ç¤ºå½±æ ¼æŒ‰éˆ• =====
        function renderFrameButtons() {
            if (!frameGrid) return;
            
            if (processedFrames.length === 0) {
                frameGrid.innerHTML = '<p class="warning-message">æ²’æœ‰å¯é¡¯ç¤ºçš„å½±æ ¼</p>';
                return;
            }
            
            let html = '';
            processedFrames.forEach(frame => {
                html += `<button class="frame-btn" data-index="${frame.index}">${frame.index}<br><small>${frame.servoCount}</small></button>`;
            });
            frameGrid.innerHTML = html;
            
            document.querySelectorAll('.frame-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    showFrame(parseInt(this.dataset.index));
                });
            });
            
            if (processedFrames.length > 0) showFrame(0);
        }
        
        // ===== é¡¯ç¤ºå½±æ ¼è©³ç´° =====
        function showFrame(index) {
            const frame = processedFrames[index];
            if (!frame) return;
            
            document.querySelectorAll('.frame-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.index) === index) btn.classList.add('active');
            });
            
            if (frameTitle) frameTitle.textContent = `å½±æ ¼ ${frame.index} (${frame.time}ms) - ${frame.servoCount}å€‹ä¼ºæœ (speed ${frame.speed})`;
            if (frameCommand) frameCommand.textContent = frame.command;
            if (frameDetail) frameDetail.style.display = 'block';
            if (sendFrameBtn) sendFrameBtn.disabled = false;
            if (copyFrameBtn) copyFrameBtn.disabled = false;
        }
        
        // ===== é¡¯ç¤ºæ‰€æœ‰æŒ‡ä»¤ =====
        function renderAllCommands() {
            if (!allCommandsOutput) return;
            
            let text = '';
            processedFrames.forEach(frame => {
                text += `// Frame ${frame.index} (${frame.time}ms)\n`;
                text += frame.command + '\n\n';
            });
            allCommandsOutput.textContent = text || '// æ²’æœ‰æŒ‡ä»¤';
        }
        
        // ===== æ›´æ–° Batch é è¦½ =====
        function updateBatchPreview() {
            if (!batchPreview) return;
            
            if (processedFrames.length === 0) {
                batchPreview.innerHTML = 'ä¸Šå‚³ JSON å¾Œæœƒé¡¯ç¤º Batch æŒ‡ä»¤';
                if (batchTotalTime) batchTotalTime.textContent = '0';
                return;
            }
            
            let text = '';
            let totalTime = 0;
            
            processedFrames.forEach(frame => {
                text += frame.command + '\n';
                totalTime += frame.time;
            });
            
            batchPreview.innerHTML = text.replace(/\n/g, '<br>');
            if (batchTotalTime) batchTotalTime.textContent = totalTime;
        }
        
        // ===== è¤‡è£½æ‰€æœ‰æŒ‡ä»¤ =====
        function copyAllCommands() {
            let text = '';
            processedFrames.forEach(frame => {
                text += `// Frame ${frame.index} (${frame.time}ms)\n`;
                text += frame.command + '\n\n';
            });
            copyToClipboard(text);
        }
        
        // ===== è¤‡è£½ Batch =====
        function copyBatch() {
            let text = '';
            processedFrames.forEach(frame => {
                text += frame.command + '\n';
            });
            copyToClipboard(text);
        }
        
        // ===== é¡¯ç¤ºçµ±è¨ˆ =====
        function renderStats() {
            if (!statsOutput) return;
            
            let html = '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">';
            html += `<p><strong>ç¸½å½±æ ¼æ•¸ï¼š</strong> ${processedFrames.length}</p>`;
            html += `<p><strong>æœ‰éƒä¼ºæœï¼š</strong> ${activeServosSet.size} å€‹</p>`;
            html += '</div>';
            
            if (Object.keys(servoMoveCount).length > 0) {
                html += '<h4 style="margin-top: 20px; margin-bottom: 10px;">ğŸ“Š ä¼ºæœç§»å‹•æ¬¡æ•¸</h4>';
                html += '<table class="servo-stats-table"><thead><tr><th>ä¼ºæœ</th><th>ç§»å‹•æ¬¡æ•¸</th></tr></thead><tbody>';
                
                const sortedServos = Object.keys(servoMoveCount).sort((a, b) => {
                    const aGroup = a.substring(0, 2), bGroup = b.substring(0, 2);
                    const aNum = parseInt(a.substring(2)), bNum = parseInt(b.substring(2));
                    if (aGroup === bGroup) return aNum - bNum;
                    return aGroup === 'HV' ? -1 : 1;
                });
                
                sortedServos.forEach(servoId => {
                    html += `<tr><td>${servoId}</td><td>${servoMoveCount[servoId]} æ¬¡</td></tr>`;
                });
                html += '</tbody></table>';
            }
            
            statsOutput.innerHTML = html;
        }
        
        // ===== ç™¼é€ Batch =====
        async function sendBatch() {
            if (!writer) {
                addSerialLog('âŒ ä¸²å£æœªé€£æ¥');
                return;
            }
            
            if (processedFrames.length === 0) {
                addSerialLog('âŒ æ²’æœ‰å¯ç™¼é€çš„æŒ‡ä»¤');
                return;
            }
            
            addSerialLog('ğŸ“¦ é–‹å§‹ç™¼é€ Batch æŒ‡ä»¤');
            
            for (let i = 0; i < processedFrames.length; i++) {
                await sendSerialCommand(processedFrames[i].command);
                // å””éœ€è¦ delayï¼Œç­‰ Premaiduino è‡ªå·± buffer
            }
            
            addSerialLog('âœ… Batch æŒ‡ä»¤ç™¼é€å®Œæˆ');
        }
        
        // ===== ç™¼é€å½±æ ¼ =====
        async function sendFrame(index) {
            if (processedFrames[index]) await sendSerialCommand(processedFrames[index].command);
        }
        
        // ===== æ’­æ”¾å…¨éƒ¨ =====
        async function playAll() {
            if (isPlaying || processedFrames.length === 0) return;
            isPlaying = true;
            addSerialLog('ğŸ¬ é–‹å§‹æ’­æ”¾å…¨éƒ¨å½±æ ¼');
            
            for (let i = 0; i < processedFrames.length; i++) {
                if (!isPlaying) break;
                await sendFrame(i);
                await new Promise(r => setTimeout(r, processedFrames[i].time));
            }
            
            addSerialLog('âœ… æ’­æ”¾å®Œæˆ');
            isPlaying = false;
        }
        
        // ===== ç™¼é€å›å®¶æŒ‡ä»¤ =====
        async function sendHome() {
            await sendSerialCommand(generateHomeCommand());
            addSerialLog('ğŸ  å…¨é«”å›å®¶');
        }
        
        // ===== ä¸²å£åŠŸèƒ½ =====
        async function connectSerialPort() {
            try {
                serialPort = await navigator.serial.requestPort();
                await serialPort.open({ baudRate: parseInt(baudRate.value) });
                
                writer = serialPort.writable.getWriter();
                reader = serialPort.readable.getReader();
                
                if (serialStatus) {
                    serialStatus.className = 'serial-status serial-connected';
                    serialStatus.innerHTML = 'ğŸŸ¢ å·²é€£æ¥ - ' + baudRate.value + ' baud';
                }
                
                if (disconnectSerial) disconnectSerial.disabled = false;
                if (customCommand) customCommand.disabled = false;
                if (sendCustomBtn) sendCustomBtn.disabled = false;
                if (connectSerial) connectSerial.disabled = true;
                
                addSerialLog('âœ… ä¸²å£é€£æ¥æˆåŠŸ');
                readSerial();
                
            } catch (error) {
                addSerialLog('âŒ é€£æ¥å¤±æ•—: ' + error.message);
            }
        }
        
        async function disconnectSerialPort() {
            try {
                if (writer) await writer.close();
                if (reader) await reader.cancel();
                if (serialPort) await serialPort.close();
                
                writer = null;
                reader = null;
                serialPort = null;
                
                if (serialStatus) {
                    serialStatus.className = 'serial-status serial-disconnected';
                    serialStatus.innerHTML = 'ğŸ”´ æœªé€£æ¥';
                }
                
                if (disconnectSerial) disconnectSerial.disabled = true;
                if (customCommand) customCommand.disabled = true;
                if (sendCustomBtn) sendCustomBtn.disabled = true;
                if (connectSerial) connectSerial.disabled = false;
                
                addSerialLog('ğŸ”Œ ä¸²å£å·²æ–·é–‹');
            } catch (error) {
                addSerialLog('âŒ æ–·é–‹å¤±æ•—: ' + error.message);
            }
        }
        
        async function readSerial() {
            while (serialPort && serialPort.readable) {
                try {
                    const { value, done } = await reader.read();
                    if (done) break;
                    const text = new TextDecoder().decode(value);
                    if (text.trim()) addSerialLog('ğŸ“¥ ' + text.trim());
                } catch (error) {
                    addSerialLog('âŒ è®€å–éŒ¯èª¤: ' + error.message);
                    break;
                }
            }
        }
        
        async function sendSerialCommand(cmd) {
            if (!writer) {
                addSerialLog('âŒ ä¸²å£æœªé€£æ¥');
                return false;
            }
            try {
                await writer.write(new TextEncoder().encode(cmd + '\n'));
                addSerialLog('ğŸ“¤ ' + cmd);
                return true;
            } catch (error) {
                addSerialLog('âŒ ç™¼é€å¤±æ•—: ' + error.message);
                return false;
            }
        }
        
        async function sendCustomCommand() {
            const cmd = customCommand.value.trim();
            if (cmd) {
                await sendSerialCommand(cmd);
                customCommand.value = '';
            }
        }
        
        function addSerialLog(message) {
            if (!serialLog) return;
            const time = new Date().toLocaleTimeString();
            serialLog.innerHTML += `<div>[${time}] ${message}</div>`;
            serialLog.scrollTop = serialLog.scrollHeight;
        }
        
        function saveLog() {
            if (!serialLog) return;
            const blob = new Blob([serialLog.innerText], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `serial_log_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(a.href);
            addSerialLog('ğŸ’¾ æ—¥èªŒå·²å„²å­˜');
        }
        
        function mapValue(value, inMin, inMax, outMin, outMax) {
            return ((value - inMin) * (outMax - outMin)) / (inMax - inMin) + outMin;
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => alert('âœ… å·²è¤‡è£½ï¼')).catch(() => alert('âŒ è¤‡è£½å¤±æ•—'));
        }
        
        // ===== ç¢ºä¿æ‰€æœ‰ DOM å…ƒç´ éƒ½æº–å‚™å¥½å…ˆå•Ÿå‹• =====
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>